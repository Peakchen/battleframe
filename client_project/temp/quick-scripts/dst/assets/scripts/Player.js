
                (function() {
                    var nodeEnv = typeof require !== 'undefined' && typeof process !== 'undefined';
                    var __module = nodeEnv ? module : {exports:{}};
                    var __filename = 'preview-scripts/assets/scripts/Player.js';
                    var __require = nodeEnv ? function (request) {
                        return cc.require(request);
                    } : function (request) {
                        return __quick_compile_project__.require(request, __filename);
                    };
                    function __define (exports, require, module) {
                        if (!nodeEnv) {__quick_compile_project__.registerModule(__filename, module);}"use strict";
cc._RF.push(module, '6c688v72QdOKamCGCT+xaAd', 'Player');
// scripts/Player.js

"use strict";

var Global = require("common");

var wsNet = require("wsNet");

var GM = require("gm");

cc.Class({
  "extends": cc.Component,
  properties: {
    // 主角跳跃高度
    jumpHeight: 0,
    // 主角跳跃持续时间
    jumpDuration: 0,
    // 最大移动速度
    maxMoveSpeed: 0,
    // 加速度
    accel: 0,
    // 跳跃音效资源
    jumpAudio: {
      "default": null,
      type: cc.AudioClip
    },
    //
    accDirection: 0
  },
  getwsNetObj: function getwsNetObj() {
    return new wsNet();
  },
  getGMObj: function getGMObj() {
    return new GM();
  },
  setJumpAction: function setJumpAction() {
    // 跳跃上升
    var jumpUp = cc.moveBy(this.jumpDuration, cc.v2(0, this.jumpHeight)).easing(cc.easeCubicActionOut()); // 下落

    var jumpDown = cc.moveBy(this.jumpDuration, cc.v2(0, -this.jumpHeight)).easing(cc.easeCubicActionIn()); // 添加一个回调函数，用于在动作结束时调用我们定义的其他方法

    var callback = cc.callFunc(this.playJumpSound, this); // 不断重复，而且每次完成落地动作后调用回调来播放声音

    return cc.repeatForever(cc.sequence(jumpUp, jumpDown, callback));
  },
  playJumpSound: function playJumpSound() {
    // 调用声音引擎播放声音
    cc.audioEngine.playEffect(this.jumpAudio, false);
  },
  onKeyDown: function onKeyDown(event) {
    // set a flag when key pressed
    switch (event.keyCode) {
      case cc.macro.KEY.a:
        this.accLeft = true;
        break;

      case cc.macro.KEY.d:
        this.accRight = true;
        break;
    }
  },
  onKeyUp: function onKeyUp(event) {
    // unset a flag when key released
    switch (event.keyCode) {
      case cc.macro.KEY.a:
        this.accLeft = false;
        break;

      case cc.macro.KEY.d:
        this.accRight = false;
        break;
    }
  },
  onLoad: function onLoad() {
    Global.FirstLogin = null;
    Global.newStarPos = new Map(); // 加速度方向开关

    this.accLeft = false;
    this.accRight = false; // 主角当前水平方向速度

    this.xSpeed = 0; //this.xSpeed = (Math.random() - 0.5) * 2 * 10;

    this.TickFrame = 0; // 初始化键盘输入监听

    cc.systemEvent.on(cc.SystemEvent.EventType.KEY_DOWN, this.onKeyDown, this);
    cc.systemEvent.on(cc.SystemEvent.EventType.KEY_UP, this.onKeyUp, this);
  },
  checkHasUpdatedMonster: function checkHasUpdatedMonster() {
    if (Global.EnterUpdateMoster == true) {
      this.sendPlayerPos(Global.MID_SyncPos);
      Global.EnterUpdateMoster = false;
    }
  },
  onDestroy: function onDestroy() {
    // 取消键盘输入监听
    cc.systemEvent.off(cc.SystemEvent.EventType.KEY_DOWN, this.onKeyDown, this);
    cc.systemEvent.off(cc.SystemEvent.EventType.KEY_UP, this.onKeyUp, this);
  },
  sendPlayerPos: function sendPlayerPos(msgid) {
    //cc.log("send player pos: ", msgid, this.TickFrame, this.node.x, this.node.y)
    if (Global.mySessionId == null) {
      return;
    }

    var buff = new ArrayBuffer(28);
    var data = new Uint32Array(buff);
    data[0] = msgid; //消息ID

    data[1] = 5; //消息长度

    var nodexflag = 1;
    var nodex = this.node.x;

    if (nodex < 0.0) {
      nodexflag = 2;
      nodex = 0.0 - nodex;
    }

    data[2] = nodexflag; //x坐标正负

    data[3] = parseInt(nodex); //x坐标

    var nodeyflag = 1;
    var nodey = this.node.y; //-88

    if (nodey < 0.0) {
      nodeyflag = 2;
      nodey = 0.0 - nodey;
    }

    data[4] = nodeyflag; //y坐标正负

    data[5] = parseInt(nodey); //y坐标

    data[6] = Global.mySessionId;
    this.getwsNetObj().sendwsmessage(data);
  },
  checkUpdateMovePos: function checkUpdateMovePos(dt) {
    if (Global.Bumped == 1) {
      //this.xSpeed = 0
      Global.Bumped = null; //移动广播所在位置，然后获取其他小球所在位置然后进行展示

      this.sendPlayerPos(Global.MID_move);
    }

    this.TickFrame += dt;

    if (this.TickFrame > 10.0) {
      //更新帧数据
      this.sendPlayerPos(Global.MID_move);
      this.TickFrame = 0;
    }
  },
  checkSpeedUpdate: function checkSpeedUpdate(dt) {
    //方向移动操作后没任何方向操作时，则慢慢减速直至停止
    if (this.accLeft == false && this.accRight == false) {
      this.xSpeed -= 0.1;

      if (this.xSpeed < 0) {
        this.xSpeed = 0;
      }
    } // 根据当前加速度方向每帧更新速度


    if (this.accLeft) {
      this.xSpeed -= this.accel * dt;
    } else if (this.accRight) {
      this.xSpeed += this.accel * dt;
    } // 限制主角的速度不能超过最大值


    if (Math.abs(this.xSpeed) > this.maxMoveSpeed) {
      // if speed reach limit, use max speed with current direction
      this.xSpeed = this.maxMoveSpeed * this.xSpeed / Math.abs(this.xSpeed);
    } // 根据当前速度更新主角的位置

    /**
     * 超过边界则自动滚回场景内
     */


    if (this.node.x <= -595.0) {
      //this.xSpeed += this.accel * dt;
      this.xSpeed = 0;
      this.node.x = -595.0 + 20;
    } else if (this.node.x >= 595.0) {
      //this.xSpeed -= this.accel * dt;
      this.node.x = 595.0 - 20;
      this.xSpeed = 0;
    } else {
      this.node.x += this.xSpeed * dt;
    }
  },
  update: function update(dt) {
    //cc.log("player dt: ", this.node.x, this.node.y)
    //检查场景加载小球变化
    this.checkHasUpdatedMonster(); //检查方向移动和速度变化关系

    this.checkSpeedUpdate(dt); //检查碰撞和自身移动位置变化

    this.checkUpdateMovePos(dt); //cc.log("player pos: ", this.node.x, this.node.y)
  }
});

cc._RF.pop();
                    }
                    if (nodeEnv) {
                        __define(__module.exports, __require, __module);
                    }
                    else {
                        __quick_compile_project__.registerModuleFunc(__filename, function () {
                            __define(__module.exports, __require, __module);
                        });
                    }
                })();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFzc2V0c1xcc2NyaXB0c1xcUGxheWVyLmpzIl0sIm5hbWVzIjpbIkdsb2JhbCIsInJlcXVpcmUiLCJ3c05ldCIsIkdNIiwiY2MiLCJDbGFzcyIsIkNvbXBvbmVudCIsInByb3BlcnRpZXMiLCJqdW1wSGVpZ2h0IiwianVtcER1cmF0aW9uIiwibWF4TW92ZVNwZWVkIiwiYWNjZWwiLCJqdW1wQXVkaW8iLCJ0eXBlIiwiQXVkaW9DbGlwIiwiYWNjRGlyZWN0aW9uIiwiZ2V0d3NOZXRPYmoiLCJnZXRHTU9iaiIsInNldEp1bXBBY3Rpb24iLCJqdW1wVXAiLCJtb3ZlQnkiLCJ2MiIsImVhc2luZyIsImVhc2VDdWJpY0FjdGlvbk91dCIsImp1bXBEb3duIiwiZWFzZUN1YmljQWN0aW9uSW4iLCJjYWxsYmFjayIsImNhbGxGdW5jIiwicGxheUp1bXBTb3VuZCIsInJlcGVhdEZvcmV2ZXIiLCJzZXF1ZW5jZSIsImF1ZGlvRW5naW5lIiwicGxheUVmZmVjdCIsIm9uS2V5RG93biIsImV2ZW50Iiwia2V5Q29kZSIsIm1hY3JvIiwiS0VZIiwiYSIsImFjY0xlZnQiLCJkIiwiYWNjUmlnaHQiLCJvbktleVVwIiwib25Mb2FkIiwiRmlyc3RMb2dpbiIsIm5ld1N0YXJQb3MiLCJNYXAiLCJ4U3BlZWQiLCJUaWNrRnJhbWUiLCJzeXN0ZW1FdmVudCIsIm9uIiwiU3lzdGVtRXZlbnQiLCJFdmVudFR5cGUiLCJLRVlfRE9XTiIsIktFWV9VUCIsImNoZWNrSGFzVXBkYXRlZE1vbnN0ZXIiLCJFbnRlclVwZGF0ZU1vc3RlciIsInNlbmRQbGF5ZXJQb3MiLCJNSURfU3luY1BvcyIsIm9uRGVzdHJveSIsIm9mZiIsIm1zZ2lkIiwibXlTZXNzaW9uSWQiLCJidWZmIiwiQXJyYXlCdWZmZXIiLCJkYXRhIiwiVWludDMyQXJyYXkiLCJub2RleGZsYWciLCJub2RleCIsIm5vZGUiLCJ4IiwicGFyc2VJbnQiLCJub2RleWZsYWciLCJub2RleSIsInkiLCJzZW5kd3NtZXNzYWdlIiwiY2hlY2tVcGRhdGVNb3ZlUG9zIiwiZHQiLCJCdW1wZWQiLCJNSURfbW92ZSIsImNoZWNrU3BlZWRVcGRhdGUiLCJNYXRoIiwiYWJzIiwidXBkYXRlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLElBQUlBLE1BQU0sR0FBR0MsT0FBTyxDQUFDLFFBQUQsQ0FBcEI7O0FBQ0EsSUFBSUMsS0FBSyxHQUFHRCxPQUFPLENBQUMsT0FBRCxDQUFuQjs7QUFDQSxJQUFJRSxFQUFFLEdBQUdGLE9BQU8sQ0FBQyxJQUFELENBQWhCOztBQUVBRyxFQUFFLENBQUNDLEtBQUgsQ0FBUztBQUNMLGFBQVNELEVBQUUsQ0FBQ0UsU0FEUDtBQUdMQyxFQUFBQSxVQUFVLEVBQUU7QUFDUjtBQUNBQyxJQUFBQSxVQUFVLEVBQUUsQ0FGSjtBQUdSO0FBQ0FDLElBQUFBLFlBQVksRUFBRSxDQUpOO0FBS1I7QUFDQUMsSUFBQUEsWUFBWSxFQUFFLENBTk47QUFPUjtBQUNBQyxJQUFBQSxLQUFLLEVBQUUsQ0FSQztBQVNSO0FBQ0FDLElBQUFBLFNBQVMsRUFBRTtBQUNQLGlCQUFTLElBREY7QUFFUEMsTUFBQUEsSUFBSSxFQUFFVCxFQUFFLENBQUNVO0FBRkYsS0FWSDtBQWNSO0FBQ0FDLElBQUFBLFlBQVksRUFBRTtBQWZOLEdBSFA7QUFxQkxDLEVBQUFBLFdBQVcsRUFBRSx1QkFBVztBQUNwQixXQUFPLElBQUlkLEtBQUosRUFBUDtBQUNILEdBdkJJO0FBeUJMZSxFQUFBQSxRQUFRLEVBQUUsb0JBQVc7QUFDakIsV0FBTyxJQUFJZCxFQUFKLEVBQVA7QUFDSCxHQTNCSTtBQTZCTGUsRUFBQUEsYUFBYSxFQUFFLHlCQUFZO0FBQ3ZCO0FBQ0EsUUFBSUMsTUFBTSxHQUFHZixFQUFFLENBQUNnQixNQUFILENBQVUsS0FBS1gsWUFBZixFQUE2QkwsRUFBRSxDQUFDaUIsRUFBSCxDQUFNLENBQU4sRUFBUyxLQUFLYixVQUFkLENBQTdCLEVBQXdEYyxNQUF4RCxDQUErRGxCLEVBQUUsQ0FBQ21CLGtCQUFILEVBQS9ELENB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LFNBQUt5QixnQkFBTCxDQUFzQkgsRUFBdEIsRUFMa0IsQ0FNbEI7O0FBQ0EsU0FBS0Qsa0JBQUwsQ0FBd0JDLEVBQXhCLEVBUGtCLENBUWxCO0FBQ0g7QUF4TUksQ0FBVCIsInNvdXJjZVJvb3QiOiIvIiwic291cmNlc0NvbnRlbnQiOlsibGV0IEdsb2JhbCA9IHJlcXVpcmUoXCJjb21tb25cIilcbmxldCB3c05ldCA9IHJlcXVpcmUoXCJ3c05ldFwiKVxubGV0IEdNID0gcmVxdWlyZShcImdtXCIpXG5cbmNjLkNsYXNzKHtcbiAgICBleHRlbmRzOiBjYy5Db21wb25lbnQsXG4gICAgXG4gICAgcHJvcGVydGllczoge1xuICAgICAgICAvLyDkuLvop5Lot7Pot4Ppq5jluqZcbiAgICAgICAganVtcEhlaWdodDogMCxcbiAgICAgICAgLy8g5Li76KeS6Lez6LeD5oyB57ut5pe26Ze0XG4gICAgICAgIGp1bXBEdXJhdGlvbjogMCxcbiAgICAgICAgLy8g5pyA5aSn56e75Yqo6YCf5bqmXG4gICAgICAgIG1heE1vdmVTcGVlZDogMCxcbiAgICAgICAgLy8g5Yqg6YCf5bqmXG4gICAgICAgIGFjY2VsOiAwLFxuICAgICAgICAvLyDot7Pot4Ppn7PmlYjotYTmupBcbiAgICAgICAganVtcEF1ZGlvOiB7XG4gICAgICAgICAgICBkZWZhdWx0OiBudWxsLFxuICAgICAgICAgICAgdHlwZTogY2MuQXVkaW9DbGlwXG4gICAgICAgIH0sXG4gICAgICAgIC8vXG4gICAgICAgIGFjY0RpcmVjdGlvbjogMCxcbiAgICB9LFxuXG4gICAgZ2V0d3NOZXRPYmo6IGZ1bmN0aW9uKCkge1xuICAgICAgICByZXR1cm4gbmV3IHdzTmV0KCk7XG4gICAgfSxcblxuICAgIGdldEdNT2JqOiBmdW5jdGlvbigpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBHTSgpO1xuICAgIH0sXG5cbiAgICBzZXRKdW1wQWN0aW9uOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgIC8vIOi3s+i3g+S4iuWNh1xuICAgICAgICB2YXIganVtcFVwID0gY2MubW92ZUJ5KHRoaXMuanVtcER1cmF0aW9uLCBjYy52MigwLCB0aGlzLmp1bXBIZWlnaHQpKS5lYXNpbmcoY2MuZWFzZUN1YmljQWN0aW9uT3V0KCkpO1xuICAgICAgICAvLyDkuIvokL1cbiAgICAgICAgdmFyIGp1bXBEb3duID0gY2MubW92ZUJ5KHRoaXMuanVtcER1cmF0aW9uLCBjYy52MigwLCAtdGhpcy5qdW1wSGVpZ2h0KSkuZWFzaW5nKGNjLmVhc2VDdWJpY0FjdGlvbkluKCkpO1xuICAgICAgICAvLyDmt7vliqDkuIDkuKrlm57osIPlh73mlbDvvIznlKjkuo7lnKjliqjkvZznu5PmnZ/ml7bosIPnlKjmiJHku6zlrprkuYnnmoTlhbbku5bmlrnms5VcbiAgICAgICAgdmFyIGNhbGxiYWNrID0gY2MuY2FsbEZ1bmModGhpcy5wbGF5SnVtcFNvdW5kLCB0aGlzKTtcbiAgICAgICAgLy8g5LiN5pat6YeN5aSN77yM6ICM5LiU5q+P5qyh5a6M5oiQ6JC95Zyw5Yqo5L2c5ZCO6LCD55So5Zue6LCD5p2l5pKt5pS+5aOw6Z+zXG4gICAgICAgIHJldHVybiBjYy5yZXBlYXRGb3JldmVyKGNjLnNlcXVlbmNlKGp1bXBVcCwganVtcERvd24sIGNhbGxiYWNrKSk7XG4gICAgfSxcblxuICAgIHBsYXlKdW1wU291bmQ6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgLy8g6LCD55So5aOw6Z+z5byV5pOO5pKt5pS+5aOw6Z+zXG4gICAgICAgIGNjLmF1ZGlvRW5naW5lLnBsYXlFZmZlY3QodGhpcy5qdW1wQXVkaW8sIGZhbHNlKTtcbiAgICB9LFxuXG4gICAgb25LZXlEb3duIChldmVudCkge1xuICAgICAgICAvLyBzZXQgYSBmbGFnIHdoZW4ga2V5IHByZXNzZWRcbiAgICAgICAgc3dpdGNoKGV2ZW50LmtleUNvZGUpIHtcbiAgICAgICAgICAgIGNhc2UgY2MubWFjcm8uS0VZLmE6XG4gICAgICAgICAgICAgICAgdGhpcy5hY2NMZWZ0ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgY2MubWFjcm8uS0VZLmQ6XG4gICAgICAgICAgICAgICAgdGhpcy5hY2NSaWdodCA9IHRydWU7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICB9LFxuXG4gICAgb25LZXlVcCAoZXZlbnQpIHtcbiAgICAgICAgLy8gdW5zZXQgYSBmbGFnIHdoZW4ga2V5IHJlbGVhc2VkXG4gICAgICAgIHN3aXRjaChldmVudC5rZXlDb2RlKSB7XG4gICAgICAgICAgICBjYXNlIGNjLm1hY3JvLktFWS5hOlxuICAgICAgICAgICAgICAgIHRoaXMuYWNjTGVmdCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBjYy5tYWNyby5LRVkuZDpcbiAgICAgICAgICAgICAgICB0aGlzLmFjY1JpZ2h0ID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICB9LFxuXG4gICAgb25Mb2FkOiBmdW5jdGlvbigpIHtcbiAgICAgICAgXG4gICAgICAgIEdsb2JhbC5GaXJzdExvZ2luID0gbnVsbFxuICAgICAgICBHbG9iYWwubmV3U3RhclBvcyA9IG5ldyBNYXAoKTtcblxuICAgICAgICAvLyDliqDpgJ/luqbmlrnlkJHlvIDlhbNcbiAgICAgICAgdGhpcy5hY2NMZWZ0ID0gZmFsc2U7XG4gICAgICAgIHRoaXMuYWNjUmlnaHQgPSBmYWxzZTtcblxuICAgICAgICAvLyDkuLvop5LlvZPliY3msLTlubPmlrnlkJHpgJ/luqZcbiAgICAgICAgdGhpcy54U3BlZWQgPSAwXG4gICAgICAgIC8vdGhpcy54U3BlZWQgPSAoTWF0aC5yYW5kb20oKSAtIDAuNSkgKiAyICogMTA7XG4gICAgICAgIHRoaXMuVGlja0ZyYW1lID0gMDtcbiAgICAgICAgLy8g5Yid5aeL5YyW6ZSu55uY6L6T5YWl55uR5ZCsXG4gICAgICAgIGNjLnN5c3RlbUV2ZW50Lm9uKGNjLlN5c3RlbUV2ZW50LkV2ZW50VHlwZS5LRVlfRE9XTiwgdGhpcy5vbktleURvd24sIHRoaXMpO1xuICAgICAgICBjYy5zeXN0ZW1FdmVudC5vbihjYy5TeXN0ZW1FdmVudC5FdmVudFR5cGUuS0VZX1VQLCB0aGlzLm9uS2V5VXAsIHRoaXMpOyAgXG4gICAgICAgIFxuICAgIH0sXG5cbiAgICBjaGVja0hhc1VwZGF0ZWRNb25zdGVyOiBmdW5jdGlvbigpe1xuICAgICAgICBpZiAoR2xvYmFsLkVudGVyVXBkYXRlTW9zdGVyID09IHRydWUpIHtcbiAgICAgICAgICAgIHRoaXMuc2VuZFBsYXllclBvcyhHbG9iYWwuTUlEX1N5bmNQb3MpXG4gICAgICAgICAgICBHbG9iYWwuRW50ZXJVcGRhdGVNb3N0ZXIgPSBmYWxzZVxuICAgICAgICB9XG4gICAgfSxcblxuICAgIG9uRGVzdHJveSAoKSB7XG4gICAgICAgIC8vIOWPlua2iOmUruebmOi+k+WFpeebkeWQrFxuICAgICAgICBjYy5zeXN0ZW1FdmVudC5vZmYoY2MuU3lzdGVtRXZlbnQuRXZlbnRUeXBlLktFWV9ET1dOLCB0aGlzLm9uS2V5RG93biwgdGhpcyk7XG4gICAgICAgIGNjLnN5c3RlbUV2ZW50Lm9mZihjYy5TeXN0ZW1FdmVudC5FdmVudFR5cGUuS0VZX1VQLCB0aGlzLm9uS2V5VXAsIHRoaXMpO1xuICAgIH0sICAgIFxuXG4gICAgc2VuZFBsYXllclBvczogZnVuY3Rpb24obXNnaWQpIHtcbiAgICAgICAgLy9jYy5sb2coXCJzZW5kIHBsYXllciBwb3M6IFwiLCBtc2dpZCwgdGhpcy5UaWNrRnJhbWUsIHRoaXMubm9kZS54LCB0aGlzLm5vZGUueSlcblxuICAgICAgICBpZiAoR2xvYmFsLm15U2Vzc2lvbklkID09IG51bGwpIHtcbiAgICAgICAgICAgIHJldHVyblxuICAgICAgICB9XG5cbiAgICAgICAgdmFyIGJ1ZmYgPSBuZXcgQXJyYXlCdWZmZXIoMjgpXG4gICAgICAgIHZhciBkYXRhID0gbmV3IFVpbnQzMkFycmF5KGJ1ZmYpXG5cbiAgICAgICAgZGF0YVswXSA9IG1zZ2lkIC8v5raI5oGvSURcbiAgICAgICAgZGF0YVsxXSA9IDUgLy/mtojmga/plb/luqZcblxuICAgICAgICB2YXIgbm9kZXhmbGFnID0gMVxuICAgICAgICB2YXIgbm9kZXggPSB0aGlzLm5vZGUueFxuICAgICAgICBpZiAobm9kZXggPCAwLjApIHtcbiAgICAgICAgICAgIG5vZGV4ZmxhZyA9IDJcbiAgICAgICAgICAgIG5vZGV4ID0gMC4wIC0gbm9kZXhcbiAgICAgICAgfVxuXG4gICAgICAgIGRhdGFbMl0gPSBub2RleGZsYWcgICAgIC8veOWdkOagh+ato+i0n1xuICAgICAgICBkYXRhWzNdID0gcGFyc2VJbnQobm9kZXgpIC8veOWdkOagh1xuICAgICAgICB2YXIgbm9kZXlmbGFnID0gMVxuICAgICAgICB2YXIgbm9kZXkgPSB0aGlzLm5vZGUueSAgLy8tODhcbiAgICAgICAgaWYgKG5vZGV5IDwgMC4wKSB7XG4gICAgICAgICAgICBub2RleWZsYWcgPSAyXG4gICAgICAgICAgICBub2RleSA9IDAuMCAtIG5vZGV5XG4gICAgICAgIH1cblxuICAgICAgICBkYXRhWzRdID0gbm9kZXlmbGFnICAgIC8veeWdkOagh+ato+i0n1xuICAgICAgICBkYXRhWzVdID0gcGFyc2VJbnQobm9kZXkpIC8veeWdkOagh1xuICAgICAgICBkYXRhWzZdID0gR2xvYmFsLm15U2Vzc2lvbklkXG5cbiAgICAgICAgdGhpcy5nZXR3c05ldE9iaigpLnNlbmR3c21lc3NhZ2UoZGF0YSlcbiAgICB9LFxuXG4gICAgY2hlY2tVcGRhdGVNb3ZlUG9zOiBmdW5jdGlvbihkdCl7XG4gICAgICAgIGlmIChHbG9iYWwuQnVtcGVkID09IDEpe1xuICAgICAgICAgICAgLy90aGlzLnhTcGVlZCA9IDBcbiAgICAgICAgICAgIEdsb2JhbC5CdW1wZWQgPSBudWxsXG4gICAgICAgICAgICAvL+enu+WKqOW5v+aSreaJgOWcqOS9jee9ru+8jOeEtuWQjuiOt+WPluWFtuS7luWwj+eQg+aJgOWcqOS9jee9rueEtuWQjui/m+ihjOWxleekulxuICAgICAgICAgICAgdGhpcy5zZW5kUGxheWVyUG9zKEdsb2JhbC5NSURfbW92ZSlcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuVGlja0ZyYW1lICs9IGR0XG4gICAgICAgIGlmICh0aGlzLlRpY2tGcmFtZSA+IDEwLjAgKXtcbiAgICAgICAgICAgIC8v5pu05paw5bin5pWw5o2uXG4gICAgICAgICAgICB0aGlzLnNlbmRQbGF5ZXJQb3MoR2xvYmFsLk1JRF9tb3ZlKVxuICAgICAgICAgICAgdGhpcy5UaWNrRnJhbWUgPSAwXG4gICAgICAgIH1cbiAgICB9LFxuXG4gICAgY2hlY2tTcGVlZFVwZGF0ZTogZnVuY3Rpb24oZHQpe1xuICAgICAgICAvL+aWueWQkeenu+WKqOaTjeS9nOWQjuayoeS7u+S9leaWueWQkeaTjeS9nOaXtu+8jOWImeaFouaFouWHj+mAn+ebtOiHs+WBnOatolxuICAgICAgICBpZiAodGhpcy5hY2NMZWZ0ID09IGZhbHNlICYmIHRoaXMuYWNjUmlnaHQgPT0gZmFsc2UpIHtcbiAgICAgICAgICAgIHRoaXMueFNwZWVkIC09IDAuMVxuICAgICAgICAgICAgaWYgKHRoaXMueFNwZWVkIDwgMCApIHtcbiAgICAgICAgICAgICAgICB0aGlzLnhTcGVlZCA9IDBcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8vIOagueaNruW9k+WJjeWKoOmAn+W6puaWueWQkeavj+W4p+abtOaWsOmAn+W6plxuICAgICAgICBpZiAodGhpcy5hY2NMZWZ0KSB7XG4gICAgICAgICAgICB0aGlzLnhTcGVlZCAtPSB0aGlzLmFjY2VsICogZHQ7XG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy5hY2NSaWdodCkge1xuICAgICAgICAgICAgdGhpcy54U3BlZWQgKz0gdGhpcy5hY2NlbCAqIGR0O1xuICAgICAgICB9XG4gICAgICAgIC8vIOmZkOWItuS4u+inkueahOmAn+W6puS4jeiDvei2hei/h+acgOWkp+WAvFxuICAgICAgICBpZiAoIE1hdGguYWJzKHRoaXMueFNwZWVkKSA+IHRoaXMubWF4TW92ZVNwZWVkICkge1xuICAgICAgICAgICAgLy8gaWYgc3BlZWQgcmVhY2ggbGltaXQsIHVzZSBtYXggc3BlZWQgd2l0aCBjdXJyZW50IGRpcmVjdGlvblxuICAgICAgICAgICAgdGhpcy54U3BlZWQgPSB0aGlzLm1heE1vdmVTcGVlZCAqIHRoaXMueFNwZWVkIC8gTWF0aC5hYnModGhpcy54U3BlZWQpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8g5qC55o2u5b2T5YmN6YCf5bqm5pu05paw5Li76KeS55qE5L2N572uXG4gICAgICAgIC8qKlxuICAgICAgICAgKiDotoXov4fovrnnlYzliJnoh6rliqjmu5rlm57lnLrmma/lhoVcbiAgICAgICAgICovXG4gICAgICAgIGlmICh0aGlzLm5vZGUueCA8PSAtNTk1LjApIHtcbiAgICAgICAgICAgIC8vdGhpcy54U3BlZWQgKz0gdGhpcy5hY2NlbCAqIGR0O1xuICAgICAgICAgICAgdGhpcy54U3BlZWQgPSAwXG4gICAgICAgICAgICB0aGlzLm5vZGUueCA9IC01OTUuMCArIDIwXG4gICAgICAgIH1lbHNlIGlmICh0aGlzLm5vZGUueCA+PSA1OTUuMCkge1xuICAgICAgICAgICAgLy90aGlzLnhTcGVlZCAtPSB0aGlzLmFjY2VsICogZHQ7XG4gICAgICAgICAgICB0aGlzLm5vZGUueCA9IDU5NS4wIC0gMjBcbiAgICAgICAgICAgIHRoaXMueFNwZWVkID0gMFxuICAgICAgICB9ZWxzZXtcbiAgICAgICAgICAgIHRoaXMubm9kZS54ICs9IHRoaXMueFNwZWVkICogZHQ7XG4gICAgICAgIH1cbiAgICB9LFxuXG4gICAgdXBkYXRlOiBmdW5jdGlvbiAoZHQpIHtcbiAgICAgICAgLy9jYy5sb2coXCJwbGF5ZXIgZHQ6IFwiLCB0aGlzLm5vZGUueCwgdGhpcy5ub2RlLnkpXG4gICAgICAgIC8v5qOA5p+l5Zy65pmv5Yqg6L295bCP55CD5Y+Y5YyWXG4gICAgICAgIHRoaXMuY2hlY2tIYXNVcGRhdGVkTW9uc3RlcigpXG4gICAgICAgIC8v5qOA5p+l5pa55ZCR56e75Yqo5ZKM6YCf5bqm5Y+Y5YyW5YWz57O7XG4gICAgICAgIHRoaXMuY2hlY2tTcGVlZFVwZGF0ZShkdClcbiAgICAgICAgLy/mo4Dmn6XnorDmkp7lkozoh6rouqvnp7vliqjkvY3nva7lj5jljJZcbiAgICAgICAgdGhpcy5jaGVja1VwZGF0ZU1vdmVQb3MoZHQpXG4gICAgICAgIC8vY2MubG9nKFwicGxheWVyIHBvczogXCIsIHRoaXMubm9kZS54LCB0aGlzLm5vZGUueSlcbiAgICB9LFxufSk7XG5cblxuIl19