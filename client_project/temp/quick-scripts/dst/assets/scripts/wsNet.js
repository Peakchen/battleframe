
                (function() {
                    var nodeEnv = typeof require !== 'undefined' && typeof process !== 'undefined';
                    var __module = nodeEnv ? module : {exports:{}};
                    var __filename = 'preview-scripts/assets/scripts/wsNet.js';
                    var __require = nodeEnv ? function (request) {
                        return cc.require(request);
                    } : function (request) {
                        return __quick_compile_project__.require(request, __filename);
                    };
                    function __define (exports, require, module) {
                        if (!nodeEnv) {__quick_compile_project__.registerModule(__filename, module);}"use strict";
cc._RF.push(module, 'f5f02ULtVhD47PNH08lZ5uR', 'wsNet');
// scripts/wsNet.js

"use strict";

/**
 * websocket 
 */
var Global = require("common"); //心跳检测


var HeartCheck = {
  timeout: 60000,
  //60秒
  timeoutObj: null,
  serverTimeoutObj: null,
  disconnectioned: false,
  reconnectTimeoutobj: null,
  reset: function reset() {
    clearTimeout(this.timeoutObj);
    clearTimeout(this.serverTimeoutObj);
    return this;
  },
  startHeartBeat: function startHeartBeat() {
    var self = this;
    this.timeoutObj = setTimeout(function () {
      //这里发送一个心跳，后端收到后，返回一个心跳消息，onmessage拿到返回的心跳就说明连接正常
      cc.log("send heart beat...");

      if (Global.ws == null) {
        return;
      }

      var buff = new ArrayBuffer(12);
      var data = new Uint32Array(buff);
      data[0] = Global.MID_HeartBeat; //消息ID

      data[1] = 1; //消息长度

      data[2] = 0; //anything 随意填充一个数

      Global.ws.send(data);
      self.serverTimeoutObj = setTimeout(function () {
        //心跳超时主动断开
        cc.log("close connection...");

        if (Global.ws == null) {
          return;
        }

        Global.ws.close();
        self.disconnectioned = true;
      }, self.timeout);
    }, this.timeout);
  },
  hasDisconnected: function hasDisconnected() {
    return this.disconnectioned;
  },
  stopReconnectTimer: function stopReconnectTimer() {
    //cc.log("close reconnectTimeout...")
    clearTimeout(this.reconnectTimeoutobj);
  }
};
/**
 * 消息回复处理
 */

var MessageStateFunc = {
  /**
   * 消息解析 
   * 0: 消息id
   * 1：消息长度
   * 2：sessionid
   * 3：nodex x坐标正负标记
   * 4：nodex x坐标值
   * 5：nodey y坐标正负标记
   * 6：nodey y坐标值 
   */
  onlogin: function onlogin(data) {
    cc.log("ws message MID_login: ", data[2], data[3]);
    Global.LoginSucc = data[2];

    if (data[2] == 1) {
      Global.mySessionId = data[3];
    } //cc.log("ws message MID_login: ", Global.newPlayerIds.length, key, Global.NewplayerMap.has(key))

  },
  onlogout: function onlogout(data) {
    var key = data[2].toString();
    cc.log("ws message MID_logout, sessionid: ", key);
    Global.DelPlayerIds.push(key);
    Global.PlayerSessionMap["delete"](key);
  },
  onmove: function onmove(data) {
    //cc.log("ws message MID_move: ", data[1], data[2], data[3], data[4], data[5], data[6])
    var key = data[2].toString();
    var nodex = data[4];
    var nodey = data[6];

    if (data[3] == 2) {
      nodex = 0 - nodex;
    }

    if (data[5] == 2) {
      nodey = 0 - nodey;
    }

    var playerProp = {
      sessionId: data[2],
      nodex: nodex,
      nodey: nodey
    };

    if (Global.PlayerSessionMap.has(key) == false) {
      Global.PlayerSessionMap.set(key, playerProp);
    }

    Global.NewplayerMap.set(key, playerProp);
    Global.newPlayerIds.push(key); //cc.log("MID_move purple monsters: ", Global.newPlayerIds.length, key, Global.NewplayerMap.has(key))
  },
  onBump: function onBump(data) {
    cc.log("ws message MID_Bump: ", data[1], data[2], data[3], data[4], data[5], data[6]);
    /**
     *  0: 消息ID
        1：消息长度
        2: 成功失败标志 (失败则只需要前三个字段)
        3: 星星x坐标正负标志
        4: 星星x坐标
        5：星星y坐标正负标志
        6：星星y坐标
        */

    if (data[2] == 0) {
      //失败
      cc.log("ws message MID_Bump fail ... ");
      return;
    }

    var nodex = data[4];
    var nodey = data[6];

    if (data[3] == 2) {
      nodex = 0 - nodex;
    }

    if (data[5] == 2) {
      nodey = 0 - nodey;
    }

    var starProp = {
      nodex: nodex,
      nodey: nodey
    };
    Global.newStarPos.set(Global.newStarKey, starProp);
  },
  onHeartBeat: function onHeartBeat(data) {
    cc.log("ws message MID_HeartBeat: ", msgid);
  },
  onStarBorn: function onStarBorn(data) {
    cc.log("ws message MID_StarBorn: ", data[2], data[3], data[4], data[5]);
    /**
     *  0: 消息ID
        1：消息长度
        2: 星星x坐标正负标志
        3: 星星x坐标
        4：星星y坐标正负标志
        5：星星y坐标
     */

    var nodex = data[3];
    var nodey = data[5];

    if (data[2] == 2) {
      nodex = 0 - nodex;
    }

    if (data[4] == 2) {
      nodey = 0 - nodey;
    }

    var starProp = {
      nodex: nodex,
      nodey: nodey
    };
    Global.newStarPos.set(Global.newStarKey, starProp);
  },
  onGM: function onGM(data) {
    cc.log("ws message MID_GM...");
  },
  Online4Other: function Online4Other(data) {
    cc.log("ws message MID_Online4Other: ", data[1], data[2], data[3], data[4], data[5], data[6]);
    var key = data[2].toString();
    var nodex = data[4];
    var nodey = data[6];

    if (data[3] == 2) {
      nodex = 0 - nodex;
    }

    if (data[5] == 2) {
      nodey = 0 - nodey;
    }

    var playerProp = {
      sessionId: data[2],
      nodex: nodex,
      nodey: nodey
    };

    if (Global.PlayerSessionMap.has(key) == false) {
      Global.PlayerSessionMap.set(key, playerProp);
    }

    Global.NewplayerMap.set(key, playerProp);
    Global.newPlayerIds.push(key);
  },
  onRegister: function onRegister(data) {
    cc.log("ws message MID_Register: ", data[2]);
    Global.RegisterSucc = data[2];
  }
};
cc.Class({
  //extends: cc.Component,

  /*
  readyState:
      CONNECTING 0
      OPEN       1
      CLOSING    2
      CLOSED     3
  */
  CanSendMsg: function CanSendMsg() {
    if (Global.ws == null) {
      return false;
    }

    return Global.ws.readyState == WebSocket.CONNECTING || Global.ws.readyState == WebSocket.OPEN;
  },
  swConnect: function swConnect() {
    if (Global.ws != null) {
      //return
      //cc.log("readyState: ", Global.ws.readyState)
      if (Global.ws.readyState == WebSocket.CONNECTING || Global.ws.readyState == WebSocket.OPEN) {
        //已经连上就不必再连
        return;
      }
    }

    var self = this;
    cc.log("addr: ", Global.wsAddr, Global.ws == null);
    var ws = new WebSocket(Global.wsAddr);

    ws.onopen = function (e) {
      cc.log("ws open: ", ws.readyState); //发送心跳

      HeartCheck.reset().startHeartBeat();
    };

    ws.onmessage = function (e) {
      var data = new Uint32Array(e.data);
      var msgid = data[0];

      switch (msgid) {
        case Global.MID_login:
          MessageStateFunc.onlogin(data);
          break;

        case Global.MID_logout:
          MessageStateFunc.onlogout(data);
          break;

        case Global.MID_move:
          MessageStateFunc.onmove(data);
          break;

        case Global.MID_Bump:
          MessageStateFunc.onBump(data);
          break;

        case Global.MID_HeartBeat:
          MessageStateFunc.onHeartBeat(data);
          break;

        case Global.MID_StarBorn:
          MessageStateFunc.onStarBorn(data);
          break;

        case Global.MID_GM:
          MessageStateFunc.onGM(data);
          break;

        case Global.MID_Online4Other:
          MessageStateFunc.Online4Other(data);
          break;

        case Global.MID_Register:
          MessageStateFunc.onRegister(data);
          break;

        default:
          cc.log("未知 消息id: ", msgid);
      } //发送心跳


      HeartCheck.reset().startHeartBeat();
    };

    ws.onerror = function (e) {
      cc.log("ws error: ", ws.readyState); //Global.ws = null

      if (HeartCheck.hasDisconnected() == false) {
        HeartCheck.stopReconnectTimer();
        HeartCheck.reconnectTimeoutobj = setTimeout(function () {
          self.swConnect();
        }, 1000);
      } else {
        HeartCheck.stopReconnectTimer();
      }
    };

    ws.onclose = function (e) {
      cc.log("ws close: ", ws.readyState); //Global.ws = null

      if (HeartCheck.hasDisconnected() == false) {
        HeartCheck.stopReconnectTimer();
        HeartCheck.reconnectTimeoutobj = setTimeout(function () {
          self.swConnect();
        }, 1000);
      } else {
        HeartCheck.stopReconnectTimer();
      }
    };

    cc.log("global ws init, state: ", ws.readyState);
    Global.ws = ws;
  },

  /**
   * 
   * @param {*} data  具体数据, 1：长度，2：是否广播，3：... 具体消息数据
   */
  sendwsmessage: function sendwsmessage(data) {
    if (Global.ws == null) {
      return;
    }

    if (Global.ws != null) {
      if (Global.ws.readyState == WebSocket.CLOSED || Global.ws.readyState == WebSocket.CLOSING) {
        //正在断开或者已经断开，则不能发送消息
        return;
      }
    } //cc.log("ws sendwsmessage: ", Global.ws.readyState)


    Global.ws.send(data);
  }
});

cc._RF.pop();
                    }
                    if (nodeEnv) {
                        __define(__module.exports, __require, __module);
                    }
                    else {
                        __quick_compile_project__.registerModuleFunc(__filename, function () {
                            __define(__module.exports, __require, __module);
                        });
                    }
                })();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFzc2V0c1xcc2NyaXB0c1xcd3NOZXQuanMiXSwibmFtZXMiOlsiR2xvYmFsIiwicmVxdWlyZSIsIkhlYXJ0Q2hlY2siLCJ0aW1lb3V0IiwidGltZW91dE9iaiIsInNlcnZlclRpbWVvdXRPYmoiLCJkaXNjb25uZWN0aW9uZWQiLCJyZWNvbm5lY3RUaW1lb3V0b2JqIiwicmVzZXQiLCJjbGVhclRpbWVvdXQiLCJzdGFydEhlYXJ0QmVhdCIsInNlbGYiLCJzZXRUaW1lb3V0IiwiY2MiLCJsb2ciLCJ3cyIsImJ1ZmYiLCJBcnJheUJ1ZmZlciIsImRhdGEiLCJVaW50MzJBcnJheSIsIk1JRF9IZWFydEJlYXQiLCJzZW5kIiwiY2xvc2UiLCJoYXNEaXNjb25uZWN0ZWQiLCJzdG9wUmVjb25uZWN0VGltZXIiLCJNZXNzYWdlU3RhdGVGdW5jIiwib25sb2dpbiIsIkxvZ2luU3VjYyIsIm15U2Vzc2lvbklkIiwib25sb2dvdXQiLCJrZXkiLCJ0b1N0cmluZyIsIkRlbFBsYXllcklkcyIsInB1c2giLCJQbGF5ZXJTZXNzaW9uTWFwIiwib25tb3ZlIiwibm9kZXgiLCJub2RleSIsInBsYXllclByb3AiLCJzZXNzaW9uSWQiLCJoYXMiLCJzZXQiLCJOZXdwbGF5ZXJNYXAiLCJuZXdQbGF5ZXJJZHMiLCJvbkJ1bXAiLCJzdGFyUHJvcCIsIm5ld1N0YXJQb3MiLCJuZXdTdGFyS2V5Iiwib25IZWFydEJlYXQiLCJtc2dpZCIsIm9uU3RhckJvcm4iLCJvbkdNIiwiT25saW5lNE90aGVyIiwib25SZWdpc3RlciIsIlJlZ2lzdGVyU3VjYyIsIkNsYXNzIiwiQ2FuU2VuZE1zZyIsInJlYWR5U3RhdGUiLCJXZWJTb2NrZXQiLCJDT05ORUNUSU5HIiwiT1BFTiIsInN3Q29ubmVjdCIsIndzQWRkciIsIm9ub3BlbiIsImUiLCJvbm1lc3NhZ2UiLCJNSURfbG9naW4iLCJNSURfbG9nb3V0IiwiTUlEX21vdmUiLCJNSURfQnVtcCIsIk1JRF9TdGFyQm9ybiIsIk1JRF9HTSIsIk1JRF9PbmxpbmU0T3RoZXIiLCJNSURfUmVnaXN0ZXIiLCJvbmVycm9yIiwib25jbG9zZSIsInNlbmR3c21lc3NhZ2UiLCJDTE9TRUQiLCJDTE9TSU5HIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7OztBQUFBOzs7QUFJQSxJQUFJQSxNQUFNLEdBQUdDLE9BQU8sQ0FBQyxRQUFELENBQXBCLEVBRUE7OztBQUNBLElBQUlDLFVBQVUsR0FBRztBQUNiQyxFQUFBQSxPQUFPLEVBQUUsS0FESTtBQUNHO0FBQ2hCQyxFQUFBQSxVQUFVLEVBQUUsSUFGQztBQUdiQyxFQUFBQSxnQkFBZ0IsRUFBRSxJQUhMO0FBSWJDLEVBQUFBLGVBQWUsRUFBRSxLQUpKO0FBS2JDLEVBQUFBLG1CQUFtQixFQUFFLElBTFI7QUFPYkMsRUFBQUEsS0FBSyxFQUFFLGlCQUFXO0FBQ2RDLElBQUFBLFlBQVksQ0FBQyxLQUFLTCxVQUFOLENBQVo7QUFDQUssSUFBQUEsWUFBWSxDQUFDLEtBQUtKLGdCQUFOLENBQVo7QUFDQSxXQUFPLElBQVA7QUFDSCxHQVhZO0FBYWJLLEVBQUFBLGNBQWMsRUFBRSwwQkFBVztBQUN2QixRQUFJQyxJQUFJLEdBQUcsSUFBWDtBQUNBLFNBQUtQLFVBQUwsR0FBa0JRLFVBQVUsQ0FBQyxZQUFXO0FBQ3BDO0FBQ0FDLE1BQUFBLEVBQUUsQ0FBQ0MsR0FBSCxDQUFPLG9CQUFQOztBQUNBLFVBQUlkLE1BQU0sQ0FBQ2UsRUFBUCxJQUFhLElBQWpCLEVBQXVCO0FBQ25CO0FBQ0g7O0FBRUQsVUFBSUMsSUFBSSxHQUFHLElBQUlDLFdBQUosQ0FBZ0IsRUFBaEIsQ0FBWDtBQUNBLFVBQUlDLElBQUksR0FBRyxJQUFJQyxXQUFKLENBQWdCSCxJQUFoQixDQUFYO0FBRUFFLE1BQUFBLElBQUksQ0FBQyxDQUFELENBQUosR0FBVWxCLE1BQU0sQ0FBQ29CLGFBQWpCLENBVm9DLENBVUw7O0FBQy9CRixNQUFBQSxJQUFJLENBQUMsQ0FBRCxDQUFKLEdBQVUsQ0FBVixDQVhvQyxDQVd4Qjs7QUFDWkEsTUFBQUEsSUFB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dCBcclxuICovXHJcblxyXG5sZXQgR2xvYmFsID0gcmVxdWlyZShcImNvbW1vblwiKVxyXG5cclxuLy/lv4Pot7Pmo4DmtYtcclxudmFyIEhlYXJ0Q2hlY2sgPSB7XHJcbiAgICB0aW1lb3V0OiA2MDAwMCwgLy82MOenklxyXG4gICAgdGltZW91dE9iajogbnVsbCxcclxuICAgIHNlcnZlclRpbWVvdXRPYmo6IG51bGwsXHJcbiAgICBkaXNjb25uZWN0aW9uZWQ6IGZhbHNlLFxyXG4gICAgcmVjb25uZWN0VGltZW91dG9iajogbnVsbCxcclxuXHJcbiAgICByZXNldDogZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMudGltZW91dE9iaik7XHJcbiAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuc2VydmVyVGltZW91dE9iaik7XHJcbiAgICAgICAgcmV0dXJuIHRoaXM7XHJcbiAgICB9LFxyXG5cclxuICAgIHN0YXJ0SGVhcnRCZWF0OiBmdW5jdGlvbigpIHtcclxuICAgICAgICB2YXIgc2VsZiA9IHRoaXM7XHJcbiAgICAgICAgdGhpcy50aW1lb3V0T2JqID0gc2V0VGltZW91dChmdW5jdGlvbigpIHtcclxuICAgICAgICAgICAgLy/ov5nph4zlj5HpgIHkuIDkuKrlv4Pot7PvvIzlkI7nq6/mlLbliLDlkI7vvIzov5Tlm57kuIDkuKrlv4Pot7Pmtojmga/vvIxvbm1lc3NhZ2Xmi7/liLDov5Tlm57nmoTlv4Pot7PlsLHor7TmmI7ov57mjqXmraPluLhcclxuICAgICAgICAgICAgY2MubG9nKFwic2VuZCBoZWFydCBiZWF0Li4uXCIpXHJcbiAgICAgICAgICAgIGlmIChHbG9iYWwud3MgPT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuXHJcbiAgICAgICAgICAgIH0gXHJcblxyXG4gICAgICAgICAgICB2YXIgYnVmZiA9IG5ldyBBcnJheUJ1ZmZlcigxMilcclxuICAgICAgICAgICAgdmFyIGRhdGEgPSBuZXcgVWludDMyQXJyYXkoYnVmZilcclxuICAgIFxyXG4gICAgICAgICAgICBkYXRhWzBdID0gR2xvYmFsLk1JRF9IZWFydEJlYXQgLy/mtojmga9JRFxyXG4gICAgICAgICAgICBkYXRhWzFdID0gMSAvL+a2iOaBr+mVv+W6plxyXG4gICAgICAgICAgICBkYXRhWzJdID0gMCAvL2FueXRoaW5nIOmaj+aEj+Whq+WFheS4gOS4quaVsFxyXG5cclxuICAgICAgICAgICAgR2xvYmFsLndzLnNlbmQoZGF0YSk7XHJcbiAgICAgICAgICAgIHNlbGYuc2VydmVyVGltZW91dE9iaiA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7IC8v5b+D6Lez6LaF5pe25Li75Yqo5pat5byAXHJcbiAgICAgICAgICAgICAgICBjYy5sb2coXCJjbG9zZSBjb25uZWN0aW9uLi4uXCIpXHJcbiAgICAgICAgICAgICAgICBpZiAoR2xvYmFsLndzID09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm5cclxuICAgICAgICAgICAgICAgIH0gXHJcbiAgICAgICAgICAgICAgICBHbG9iYWwud3MuY2xvc2UoKTtcclxuICAgICAgICAgICAgICAgIHNlbGYuZGlzY29ubmVjdGlvbmVkID0gdHJ1ZVxyXG4gICAgICAgICAgICB9LCBzZWxmLnRpbWVvdXQpXHJcbiAgICAgICAgfSwgdGhpcy50aW1lb3V0KVxyXG4gICAgfSxcclxuXHJcbiAgICBoYXNEaXNjb25uZWN0ZWQ6IGZ1bmN0aW9uKCl7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZGlzY29ubmVjdGlvbmVkXHJcbiAgICB9LFxyXG5cclxuICAgIHN0b3BSZWNvbm5lY3RUaW1lcjogZnVuY3Rpb24oKXtcclxuICAgICAgICAvL2NjLmxvZyhcImNsb3NlIHJlY29ubmVjdFRpbWVvdXQuLi5cIilcclxuICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5yZWNvbm5lY3RUaW1lb3V0b2JqKTtcclxuICAgIH1cclxufVxyXG5cclxuLyoqXHJcbiAqIOa2iOaBr+WbnuWkjeWkhOeQhlxyXG4gKi9cclxudmFyIE1lc3NhZ2VTdGF0ZUZ1bmMgPSB7XHJcbiAgICAvKipcclxuICAgICAqIOa2iOaBr+ino+aekCBcclxuICAgICAqIDA6IOa2iOaBr2lkXHJcbiAgICAgKiAx77ya5raI5oGv6ZW/5bqmXHJcbiAgICAgKiAy77yac2Vzc2lvbmlkXHJcbiAgICAgKiAz77yabm9kZXggeOWdkOagh+ato+i0n+agh+iusFxyXG4gICAgICogNO+8mm5vZGV4IHjlnZDmoIflgLxcclxuICAgICAqIDXvvJpub2RleSB55Z2Q5qCH5q2j6LSf5qCH6K6wXHJcbiAgICAgKiA277yabm9kZXkgeeWdkOagh+WAvCBcclxuICAgICAqL1xyXG4gICAgb25sb2dpbjogZnVuY3Rpb24oZGF0YSkge1xyXG4gICAgICAgIGNjLmxvZyhcIndzIG1lc3NhZ2UgTUlEX2xvZ2luOiBcIiwgZGF0YVsyXSwgZGF0YVszXSlcclxuICAgICAgICBHbG9iYWwuTG9naW5TdWNjID0gZGF0YVsyXVxyXG4gICAgICAgIGlmIChkYXRhWzJdID09IDEpIHtcclxuICAgICAgICAgICAgR2xvYmFsLm15U2Vzc2lvbklkID0gZGF0YVszXVxyXG4gICAgICAgIH1cclxuICAgICAgICAvL2NjLmxvZyhcIndzIG1lc3NhZ2UgTUlEX2xvZ2luOiBcIiwgR2xvYmFsLm5ld1BsYXllcklkcy5sZW5ndGgsIGtleSwgR2xvYmFsLk5ld3BsYXllck1hcC5oYXMoa2V5KSlcclxuICAgIH0sXHJcblxyXG4gICAgb25sb2dvdXQ6IGZ1bmN0aW9uKGRhdGEpIHtcclxuICAgICAgICB2YXIga2V5ID0gZGF0YVsyXS50b1N0cmluZygpXHJcbiAgICAgICAgY2MubG9nKFwid3MgbWVzc2FnZSBNSURfbG9nb3V0LCBzZXNzaW9uaWQ6IFwiLCBrZXkpXHJcbiAgICAgICAgR2xvYmFsLkRlbFBsYXllcklkcy5wdXNoKGtleSlcclxuICAgICAgICBHbG9iYWwuUGxheWVyU2Vzc2lvbk1hcC5kZWxldGUoa2V5KVxyXG4gICAgfSxcclxuXHJcbiAgICBvbm1vdmU6IGZ1bmN0aW9uKGRhdGEpIHtcclxuICAgICAgICAvL2NjLmxvZyhcIndzIG1lc3NhZ2UgTUlEX21vdmU6IFwiLCBkYXRhWzFdLCBkYXRhWzJdLCBkYXRhWzNdLCBkYXRhWzRdLCBkYXRhWzVdLCBkYXRhWzZdKVxyXG4gICAgICAgIHZhciBrZXkgPSBkYXRhWzJdLnRvU3RyaW5nKClcclxuICAgICAgICB2YXIgbm9kZXggPSBkYXRhWzRdXHJcbiAgICAgICAgdmFyIG5vZGV5ID0gZGF0YVs2XVxyXG4gICAgICAgIGlmIChkYXRhWzNdID09IDIpe1xyXG4gICAgICAgICAgICBub2RleCA9IDAgLSBub2RleFxyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoZGF0YVs1XSA9PSAyKXtcclxuICAgICAgICAgICAgbm9kZXkgPSAwIC0gbm9kZXlcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIHBsYXllclByb3AgPSB7XHJcbiAgICAgICAgICAgIHNlc3Npb25JZDogZGF0YVsyXSxcclxuICAgICAgICAgICAgbm9kZXg6IG5vZGV4LFxyXG4gICAgICAgICAgICBub2RleTogbm9kZXlcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKEdsb2JhbC5QbGF5ZXJTZXNzaW9uTWFwLmhhcyhrZXkpID09IGZhbHNlKSB7XHJcbiAgICAgICAgICAgIEdsb2JhbC5QbGF5ZXJTZXNzaW9uTWFwLnNldChrZXksIHBsYXllclByb3ApXHJcbiAgICAgICAgfVxyXG4gICAgICAgIEdsb2JhbC5OZXdwbGF5ZXJNYXAuc2V0KGtleSwgcGxheWVyUHJvcClcclxuICAgICAgICBHbG9iYWwubmV3UGxheWVySWRzLnB1c2goa2V5KVxyXG4gICAgICAgIC8vY2MubG9nKFwiTUlEX21vdmUgcHVycGxlIG1vbnN0ZXJzOiBcIiwgR2xvYmFsLm5ld1BsYXllcklkcy5sZW5ndGgsIGtleSwgR2xvYmFsLk5ld3BsYXllck1hcC5oYXMoa2V5KSlcclxuICAgIH0sXHJcblxyXG4gICAgb25CdW1wOiBmdW5jdGlvbiAoZGF0YSkge1xyXG4gICAgICAgIGNjLmxvZyhcIndzIG1lc3NhZ2UgTUlEX0J1bXA6IFwiLCBkYXRhWzFdLCBkYXRhWzJdLCBkYXRhWzNdLCBkYXRhWzRdLCBkYXRhWzVdLCBkYXRhWzZdKVxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqICAwOiDmtojmga9JRFxyXG4gICAgICAgICAgICAx77ya5raI5oGv6ZW/5bqmXHJcbiAgICAgICAgICAgIDI6IOaIkOWKn+Wksei0peagh+W/lyAo5aSx6LSl5YiZ5Y+q6ZyA6KaB5YmN5LiJ5Liq5a2X5q61KVxyXG4gICAgICAgICAgICAzOiDmmJ/mmJ945Z2Q5qCH5q2j6LSf5qCH5b+XXHJcbiAgICAgICAgICAgIDQ6IOaYn+aYn3jlnZDmoIdcclxuICAgICAgICAgICAgNe+8muaYn+aYn3nlnZDmoIfmraPotJ/moIflv5dcclxuICAgICAgICAgICAgNu+8muaYn+aYn3nlnZDmoIdcclxuICAgICAgICAgICAgKi9cclxuXHJcbiAgICAgICAgaWYgKGRhdGFbMl0gPT0gMCl7IC8v5aSx6LSlXHJcbiAgICAgICAgICAgIGNjLmxvZyhcIndzIG1lc3NhZ2UgTUlEX0J1bXAgZmFpbCAuLi4gXCIpXHJcbiAgICAgICAgICAgIHJldHVyblxyXG4gICAgICAgIH1cclxuICAgICAgICBcclxuICAgICAgICB2YXIgbm9kZXggPSBkYXRhWzRdXHJcbiAgICAgICAgdmFyIG5vZGV5ID0gZGF0YVs2XVxyXG4gICAgICAgIGlmIChkYXRhWzNdID09IDIpe1xyXG4gICAgICAgICAgICBub2RleCA9IDAgLSBub2RleFxyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoZGF0YVs1XSA9PSAyKXtcclxuICAgICAgICAgICAgbm9kZXkgPSAwIC0gbm9kZXlcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIHN0YXJQcm9wID0ge1xyXG4gICAgICAgICAgICBub2RleDogbm9kZXgsXHJcbiAgICAgICAgICAgIG5vZGV5OiBub2RleVxyXG4gICAgICAgIH1cclxuICAgICAgICBHbG9iYWwubmV3U3RhclBvcy5zZXQoR2xvYmFsLm5ld1N0YXJLZXksIHN0YXJQcm9wKVxyXG4gICAgfSxcclxuXHJcbiAgICBvbkhlYXJ0QmVhdDogZnVuY3Rpb24oZGF0YSl7XHJcbiAgICAgICAgY2MubG9nKFwid3MgbWVzc2FnZSBNSURfSGVhcnRCZWF0OiBcIiwgbXNnaWQpXHJcbiAgICB9LFxyXG5cclxuICAgIG9uU3RhckJvcm46IGZ1bmN0aW9uKGRhdGEpIHtcclxuICAgICAgICBjYy5sb2coXCJ3cyBtZXNzYWdlIE1JRF9TdGFyQm9ybjogXCIsIGRhdGFbMl0sIGRhdGFbM10sIGRhdGFbNF0sIGRhdGFbNV0pXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICogIDA6IOa2iOaBr0lEXHJcbiAgICAgICAgICAgIDHvvJrmtojmga/plb/luqZcclxuICAgICAgICAgICAgMjog5pif5pifeOWdkOagh+ato+i0n+agh+W/l1xyXG4gICAgICAgICAgICAzOiDmmJ/mmJ945Z2Q5qCHXHJcbiAgICAgICAgICAgIDTvvJrmmJ/mmJ955Z2Q5qCH5q2j6LSf5qCH5b+XXHJcbiAgICAgICAgICAgIDXvvJrmmJ/mmJ955Z2Q5qCHXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgdmFyIG5vZGV4ID0gZGF0YVszXVxyXG4gICAgICAgIHZhciBub2RleSA9IGRhdGFbNV1cclxuICAgICAgICBpZiAoZGF0YVsyXSA9PSAyKXtcclxuICAgICAgICAgICAgbm9kZXggPSAwIC0gbm9kZXhcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGRhdGFbNF0gPT0gMil7XHJcbiAgICAgICAgICAgIG5vZGV5ID0gMCAtIG5vZGV5XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBzdGFyUHJvcCA9IHtcclxuICAgICAgICAgICAgbm9kZXg6IG5vZGV4LFxyXG4gICAgICAgICAgICBub2RleTogbm9kZXlcclxuICAgICAgICB9XHJcbiAgICAgICAgR2xvYmFsLm5ld1N0YXJQb3Muc2V0KEdsb2JhbC5uZXdTdGFyS2V5LCBzdGFyUHJvcClcclxuICAgIH0sXHJcblxyXG4gICAgb25HTTogZnVuY3Rpb24oZGF0YSkge1xyXG4gICAgICAgIGNjLmxvZyhcIndzIG1lc3NhZ2UgTUlEX0dNLi4uXCIpXHJcbiAgICB9LFxyXG5cclxuICAgIE9ubGluZTRPdGhlcjogZnVuY3Rpb24oZGF0YSkge1xyXG4gICAgICAgIGNjLmxvZyhcIndzIG1lc3NhZ2UgTUlEX09ubGluZTRPdGhlcjogXCIsIGRhdGFbMV0sIGRhdGFbMl0sIGRhdGFbM10sIGRhdGFbNF0sIGRhdGFbNV0sIGRhdGFbNl0pXHJcbiAgICAgICAgdmFyIGtleSA9IGRhdGFbMl0udG9TdHJpbmcoKVxyXG4gICAgICAgIHZhciBub2RleCA9IGRhdGFbNF1cclxuICAgICAgICB2YXIgbm9kZXkgPSBkYXRhWzZdXHJcbiAgICAgICAgaWYgKGRhdGFbM10gPT0gMil7XHJcbiAgICAgICAgICAgIG5vZGV4ID0gMCAtIG5vZGV4XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChkYXRhWzVdID09IDIpe1xyXG4gICAgICAgICAgICBub2RleSA9IDAgLSBub2RleVxyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgcGxheWVyUHJvcCA9IHtcclxuICAgICAgICAgICAgc2Vzc2lvbklkOiBkYXRhWzJdLFxyXG4gICAgICAgICAgICBub2RleDogbm9kZXgsXHJcbiAgICAgICAgICAgIG5vZGV5OiBub2RleVxyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoR2xvYmFsLlBsYXllclNlc3Npb25NYXAuaGFzKGtleSkgPT0gZmFsc2UpIHtcclxuICAgICAgICAgICAgR2xvYmFsLlBsYXllclNlc3Npb25NYXAuc2V0KGtleSwgcGxheWVyUHJvcClcclxuICAgICAgICB9XHJcbiAgICAgICAgR2xvYmFsLk5ld3BsYXllck1hcC5zZXQoa2V5LCBwbGF5ZXJQcm9wKVxyXG4gICAgICAgIEdsb2JhbC5uZXdQbGF5ZXJJZHMucHVzaChrZXkpXHJcbiAgICB9LFxyXG5cclxuICAgIG9uUmVnaXN0ZXI6IGZ1bmN0aW9uKGRhdGEpe1xyXG4gICAgICAgIGNjLmxvZyhcIndzIG1lc3NhZ2UgTUlEX1JlZ2lzdGVyOiBcIiwgZGF0YVsyXSlcclxuICAgICAgICBHbG9iYWwuUmVnaXN0ZXJTdWNjID0gZGF0YVsyXVxyXG4gICAgfVxyXG59XHJcblxyXG5jYy5DbGFzcyh7XHJcbiAgICAvL2V4dGVuZHM6IGNjLkNvbXBvbmVudCxcclxuXHJcbiAgICAvKlxyXG4gICAgcmVhZHlTdGF0ZTpcclxuICAgICAgICBDT05ORUNUSU5HIDBcclxuICAgICAgICBPUEVOICAgICAgIDFcclxuICAgICAgICBDTE9TSU5HICAgIDJcclxuICAgICAgICBDTE9TRUQgICAgIDNcclxuICAgICovXHJcbiAgIFxyXG4gICAgQ2FuU2VuZE1zZzogZnVuY3Rpb24oKXtcclxuICAgICAgICBpZiAoR2xvYmFsLndzID09IG51bGwpe1xyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2VcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiAoR2xvYmFsLndzLnJlYWR5U3RhdGUgPT0gV2ViU29ja2V0LkNPTk5FQ1RJTkcgfHwgR2xvYmFsLndzLnJlYWR5U3RhdGUgPT0gV2ViU29ja2V0Lk9QRU4pXHJcbiAgICB9LCBcclxuXHJcbiAgICBzd0Nvbm5lY3Q6IGZ1bmN0aW9uKCl7XHJcbiAgICAgICAgaWYgKEdsb2JhbC53cyAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgIC8vcmV0dXJuXHJcbiAgICAgICAgICAgIC8vY2MubG9nKFwicmVhZHlTdGF0ZTogXCIsIEdsb2JhbC53cy5yZWFkeVN0YXRlKVxyXG4gICAgICAgICAgICBpZiAoR2xvYmFsLndzLnJlYWR5U3RhdGUgPT0gV2ViU29ja2V0LkNPTk5FQ1RJTkcgfHwgR2xvYmFsLndzLnJlYWR5U3RhdGUgPT0gV2ViU29ja2V0Lk9QRU4pIHsgLy/lt7Lnu4/ov57kuIrlsLHkuI3lv4Xlho3ov55cclxuICAgICAgICAgICAgICAgIHJldHVyblxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB2YXIgc2VsZiA9IHRoaXM7XHJcbiAgICAgICAgY2MubG9nKFwiYWRkcjogXCIsIEdsb2JhbC53c0FkZHIsIEdsb2JhbC53cyA9PSBudWxsKVxyXG4gICAgICAgIHZhciB3cyA9IG5ldyBXZWJTb2NrZXQoR2xvYmFsLndzQWRkcik7XHJcbiAgICAgICAgd3Mub25vcGVuID0gZnVuY3Rpb24oZSkge1xyXG4gICAgICAgICAgICBjYy5sb2coXCJ3cyBvcGVuOiBcIiwgd3MucmVhZHlTdGF0ZSlcclxuICAgICAgICAgICAgLy/lj5HpgIHlv4Pot7NcclxuICAgICAgICAgICAgSGVhcnRDaGVjay5yZXNldCgpLnN0YXJ0SGVhcnRCZWF0KClcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHdzLm9ubWVzc2FnZSA9IGZ1bmN0aW9uKGUpIHtcclxuICAgICAgICAgICAgdmFyIGRhdGEgPSBuZXcgVWludDMyQXJyYXkoZS5kYXRhKVxyXG4gICAgICAgICAgICB2YXIgbXNnaWQgPSBkYXRhWzBdIFxyXG4gICAgICAgICAgICBzd2l0Y2ggKG1zZ2lkKSB7XHJcbiAgICAgICAgICAgICAgICBjYXNlIEdsb2JhbC5NSURfbG9naW46XHJcbiAgICAgICAgICAgICAgICAgICAgTWVzc2FnZVN0YXRlRnVuYy5vbmxvZ2luKGRhdGEpXHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICBjYXNlIEdsb2JhbC5NSURfbG9nb3V0OlxyXG4gICAgICAgICAgICAgICAgICAgIE1lc3NhZ2VTdGF0ZUZ1bmMub25sb2dvdXQoZGF0YSlcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UgR2xvYmFsLk1JRF9tb3ZlOlxyXG4gICAgICAgICAgICAgICAgICAgIE1lc3NhZ2VTdGF0ZUZ1bmMub25tb3ZlKGRhdGEpXHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICBjYXNlIEdsb2JhbC5NSURfQnVtcDpcclxuICAgICAgICAgICAgICAgICAgICBNZXNzYWdlU3RhdGVGdW5jLm9uQnVtcChkYXRhKVxyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrXHJcbiAgICAgICAgICAgICAgICBjYXNlIEdsb2JhbC5NSURfSGVhcnRCZWF0OlxyXG4gICAgICAgICAgICAgICAgICAgIE1lc3NhZ2VTdGF0ZUZ1bmMub25IZWFydEJlYXQoZGF0YSlcclxuICAgICAgICAgICAgICAgICAgICBicmVha1xyXG4gICAgICAgICAgICAgICAgY2FzZSBHbG9iYWwuTUlEX1N0YXJCb3JuOlxyXG4gICAgICAgICAgICAgICAgICAgIE1lc3NhZ2VTdGF0ZUZ1bmMub25TdGFyQm9ybihkYXRhKVxyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrXHJcbiAgICAgICAgICAgICAgICBjYXNlIEdsb2JhbC5NSURfR006XHJcbiAgICAgICAgICAgICAgICAgICAgTWVzc2FnZVN0YXRlRnVuYy5vbkdNKGRhdGEpXHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWtcclxuICAgICAgICAgICAgICAgIGNhc2UgR2xvYmFsLk1JRF9PbmxpbmU0T3RoZXI6XHJcbiAgICAgICAgICAgICAgICAgICAgTWVzc2FnZVN0YXRlRnVuYy5PbmxpbmU0T3RoZXIoZGF0YSlcclxuICAgICAgICAgICAgICAgICAgICBicmVha1xyXG4gICAgICAgICAgICAgICAgY2FzZSBHbG9iYWwuTUlEX1JlZ2lzdGVyOlxyXG4gICAgICAgICAgICAgICAgICAgIE1lc3NhZ2VTdGF0ZUZ1bmMub25SZWdpc3RlcihkYXRhKVxyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrXHJcbiAgICAgICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgICAgIGNjLmxvZyhcIuacquefpSDmtojmga9pZDogXCIsIG1zZ2lkKVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAvL+WPkemAgeW/g+i3s1xyXG4gICAgICAgICAgICBIZWFydENoZWNrLnJlc2V0KCkuc3RhcnRIZWFydEJlYXQoKVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgd3Mub25lcnJvciA9IGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgICAgIGNjLmxvZyhcIndzIGVycm9yOiBcIiwgd3MucmVhZHlTdGF0ZSlcclxuICAgICAgICAgICAgLy9HbG9iYWwud3MgPSBudWxsXHJcbiAgICAgICAgICAgIGlmIChIZWFydENoZWNrLmhhc0Rpc2Nvbm5lY3RlZCgpID09IGZhbHNlKSB7XHJcbiAgICAgICAgICAgICAgICBIZWFydENoZWNrLnN0b3BSZWNvbm5lY3RUaW1lcigpXHJcbiAgICAgICAgICAgICAgICBIZWFydENoZWNrLnJlY29ubmVjdFRpbWVvdXRvYmogPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHNlbGYuc3dDb25uZWN0KCk7XHJcbiAgICAgICAgICAgICAgICB9LCAxMDAwKVxyXG4gICAgICAgICAgICB9ZWxzZXtcclxuICAgICAgICAgICAgICAgIEhlYXJ0Q2hlY2suc3RvcFJlY29ubmVjdFRpbWVyKClcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgd3Mub25jbG9zZSA9IGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgICAgIGNjLmxvZyhcIndzIGNsb3NlOiBcIiwgd3MucmVhZHlTdGF0ZSlcclxuICAgICAgICAgICAgLy9HbG9iYWwud3MgPSBudWxsXHJcbiAgICAgICAgICAgIGlmIChIZWFydENoZWNrLmhhc0Rpc2Nvbm5lY3RlZCgpID09IGZhbHNlKSB7XHJcbiAgICAgICAgICAgICAgICBIZWFydENoZWNrLnN0b3BSZWNvbm5lY3RUaW1lcigpXHJcbiAgICAgICAgICAgICAgICBIZWFydENoZWNrLnJlY29ubmVjdFRpbWVvdXRvYmogPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHNlbGYuc3dDb25uZWN0KCk7XHJcbiAgICAgICAgICAgICAgICB9LCAxMDAwKVxyXG4gICAgICAgICAgICB9ZWxzZXtcclxuICAgICAgICAgICAgICAgIEhlYXJ0Q2hlY2suc3RvcFJlY29ubmVjdFRpbWVyKClcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY2MubG9nKFwiZ2xvYmFsIHdzIGluaXQsIHN0YXRlOiBcIiwgd3MucmVhZHlTdGF0ZSlcclxuICAgICAgICBHbG9iYWwud3MgPSB3c1xyXG4gICAgfSxcclxuXHJcbiAgICAvKipcclxuICAgICAqIFxyXG4gICAgICogQHBhcmFtIHsqfSBkYXRhICDlhbfkvZPmlbDmja4sIDHvvJrplb/luqbvvIwy77ya5piv5ZCm5bm/5pKt77yMM++8mi4uLiDlhbfkvZPmtojmga/mlbDmja5cclxuICAgICAqL1xyXG4gICAgc2VuZHdzbWVzc2FnZTogZnVuY3Rpb24oZGF0YSl7XHJcbiAgICAgICAgXHJcbiAgICAgICAgaWYgKEdsb2JhbC53cyA9PSBudWxsKSB7XHJcbiAgICAgICAgICAgIHJldHVyblxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKEdsb2JhbC53cyAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgIGlmIChHbG9iYWwud3MucmVhZHlTdGF0ZSA9PSBXZWJTb2NrZXQuQ0xPU0VEIHx8IEdsb2JhbC53cy5yZWFkeVN0YXRlID09IFdlYlNvY2tldC5DTE9TSU5HKSB7IC8v5q2j5Zyo5pat5byA5oiW6ICF5bey57uP5pat5byA77yM5YiZ5LiN6IO95Y+R6YCB5raI5oGvXHJcbiAgICAgICAgICAgICAgICByZXR1cm5cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy9jYy5sb2coXCJ3cyBzZW5kd3NtZXNzYWdlOiBcIiwgR2xvYmFsLndzLnJlYWR5U3RhdGUpXHJcbiAgICAgICAgR2xvYmFsLndzLnNlbmQoZGF0YSlcclxuICAgIH1cclxufSkiXX0=