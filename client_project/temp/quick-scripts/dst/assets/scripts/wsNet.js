
                (function() {
                    var nodeEnv = typeof require !== 'undefined' && typeof process !== 'undefined';
                    var __module = nodeEnv ? module : {exports:{}};
                    var __filename = 'preview-scripts/assets/scripts/wsNet.js';
                    var __require = nodeEnv ? function (request) {
                        return cc.require(request);
                    } : function (request) {
                        return __quick_compile_project__.require(request, __filename);
                    };
                    function __define (exports, require, module) {
                        if (!nodeEnv) {__quick_compile_project__.registerModule(__filename, module);}"use strict";
cc._RF.push(module, 'f5f02ULtVhD47PNH08lZ5uR', 'wsNet');
// scripts/wsNet.js

"use strict";

/**
 * websocket 
 */
var Global = require("common"); //let Player = require("Player")


cc.Class({
  //extends: cc.Component,

  /*
  readyState:
      CONNECTING 0
      OPEN       1
      CLOSING    2
      CLOSED     3
  */
  CanSendMsg: function CanSendMsg() {
    if (Global.ws == null) {
      return false;
    }

    return Global.ws.readyState == WebSocket.CONNECTING || Global.ws.readyState == WebSocket.OPEN;
  },
  newPlayer: function newPlayer(arrData) {
    Global.newplayerCreated = 1;
    Global.newplayerPosx = arrData[4];

    if (arrData[3] == 2) {
      Global.newplayerPosx = 0 - Global.newplayerPosx;
    }

    Global.newplayerPosy = arrData[6];

    if (arrData[5] == 2) {
      Global.newplayerPosy = 0 - Global.newplayerPosy;
    }
  },
  swConnect: function swConnect() {
    if (Global.ws != null) {
      return;
      cc.log("readyState: ", Global.ws.readyState);

      if (Global.ws.readyState == WebSocket.CONNECTING || Global.ws.readyState == WebSocket.OPEN) {
        //已经连上就不必再连
        return;
      }
    }

    cc.log("addr: ", Global.wsAddr, Global.ws == null);
    var ws = new WebSocket(Global.wsAddr);

    ws.onopen = function (e) {
      cc.log("ws open: ", ws.readyState);
    };

    ws.onmessage = function (e) {
      /**
       * 消息解析 
       * 0: 消息id
       * 1：消息长度
       * 2：sessionid
       * 3：nodex x坐标正负标记
       * 4：nodex x坐标值
       * 5：nodey y坐标正负标记
       * 6：nodey y坐标值 
       */
      var data = new Uint32Array(e.data);
      var msgid = data[0];

      switch (msgid) {
        case Global.MID_login:
          cc.log("ws message MID_login: ", data[1], data[2], data[3], data[4], data[5], data[6]);
          var key = data[2].toString();
          var nodex = data[4];
          var nodey = data[6];

          if (data[3] == 2) {
            nodex = 0 - nodex;
          }

          if (data[5] == 2) {
            nodey = 0 - nodey;
          }

          var playerProp = {
            sessionId: data[2],
            nodex: nodex,
            nodey: nodey
          };

          if (Global.PlayerSessionMap.has(key) == false) {
            Global.PlayerSessionMap.set(key, playerProp);
          }

          Global.NewplayerMap.set(key, playerProp);
          Global.newPlayerIds.push(key);
          break;

        case Global.MID_logout:
          var key = data[2].toString();
          cc.log("ws message MID_logout, sessionid: ", key);
          Global.DelPlayerIds.push(key);
          Global.PlayerSessionMap["delete"](key);
          break;

        case Global.MID_move:
          cc.log("ws message MID_move: ", data[1], data[2], data[3], data[4], data[5], data[6]);
          var key = data[2].toString();
          var nodex = data[4];
          var nodey = data[6];

          if (data[3] == 2) {
            nodex = 0 - nodex;
          }

          if (data[5] == 2) {
            nodey = 0 - nodey;
          }

          var playerProp = {
            sessionId: data[2],
            nodex: nodex,
            nodey: nodey
          };

          if (Global.PlayerSessionMap.has(key) == false) {
            Global.PlayerSessionMap.set(key, playerProp);
          }

          Global.NewplayerMap.set(key, playerProp);
          Global.newPlayerIds.push(key);
          cc.log("MID_move purple monsters: ", Global.newPlayerIds.length);
          break;

        default:
          cc.log("未知 消息id: ", msgid);
      }
    };

    ws.onerror = function (e) {
      cc.log("ws error: ", ws.readyState);
      Global.ws = null;
    };

    ws.onclose = function (e) {
      cc.log("ws close: ", ws.readyState); //Player.sendPlayerPos()

      Global.ws = null;
    };

    cc.log("global ws init, state: ", ws.readyState);
    Global.ws = ws;
  },

  /**
   * 
   * @param {*} data  具体数据, 1：长度，2：是否广播，3：... 具体消息数据
   */
  sendwsmessage: function sendwsmessage(data) {
    if (Global.ws == null) {
      return;
    }

    if (Global.ws != null) {
      if (Global.ws.readyState == WebSocket.CLOSED || Global.ws.readyState == WebSocket.CLOSING) {
        //正在断开或者已经断开，则不能发送消息
        return;
      }
    }

    cc.log("ws sendwsmessage: ", Global.ws.readyState);
    Global.ws.send(data);
  }
});

cc._RF.pop();
                    }
                    if (nodeEnv) {
                        __define(__module.exports, __require, __module);
                    }
                    else {
                        __quick_compile_project__.registerModuleFunc(__filename, function () {
                            __define(__module.exports, __require, __module);
                        });
                    }
                })();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFzc2V0c1xcc2NyaXB0c1xcd3NOZXQuanMiXSwibmFtZXMiOlsiR2xvYmFsIiwicmVxdWlyZSIsImNjIiwiQ2xhc3MiLCJDYW5TZW5kTXNnIiwid3MiLCJyZWFkeVN0YXRlIiwiV2ViU29ja2V0IiwiQ09OTkVDVElORyIsIk9QRU4iLCJuZXdQbGF5ZXIiLCJhcnJEYXRhIiwibmV3cGxheWVyQ3JlYXRlZCIsIm5ld3BsYXllclBvc3giLCJuZXdwbGF5ZXJQb3N5Iiwic3dDb25uZWN0IiwibG9nIiwid3NBZGRyIiwib25vcGVuIiwiZSIsIm9ubWVzc2FnZSIsImRhdGEiLCJVaW50MzJBcnJheSIsIm1zZ2lkIiwiTUlEX2xvZ2luIiwia2V5IiwidG9TdHJpbmciLCJub2RleCIsIm5vZGV5IiwicGxheWVyUHJvcCIsInNlc3Npb25JZCIsIlBsYXllclNlc3Npb25NYXAiLCJoYXMiLCJzZXQiLCJOZXdwbGF5ZXJNYXAiLCJuZXdQbGF5ZXJJZHMiLCJwdXNoIiwiTUlEX2xvZ291dCIsIkRlbFBsYXllcklkcyIsIk1JRF9tb3ZlIiwibGVuZ3RoIiwib25lcnJvciIsIm9uY2xvc2UiLCJzZW5kd3NtZXNzYWdlIiwiQ0xPU0VEIiwiQ0xPU0lORyIsInNlbmQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7OztBQUlBLElBQUlBLE1BQU0sR0FBR0MsT0FBTyxDQUFDLFFBQUQsQ0FBcEIsRUFDQTs7O0FBRUFDLEVBQUUsQ0FBQ0MsS0FBSCxDQUFTO0FBQ0w7O0FBRUE7Ozs7Ozs7QUFRQUMsRUFBQUEsVUFBVSxFQUFFLHNCQUFVO0FBQ2xCLFFBQUlKLE1BQU0sQ0FBQ0ssRUFBUCxJQUFhLElBQWpCLEVBQXNCO0FBQ2xCLGFBQU8sS0FBUDtBQUNIOztBQUVELFdBQVFMLE1BQU0sQ0FBQ0ssRUFBUCxDQUFVQyxVQUFWLElBQXdCQyxTQUFTLENBQUNDLFVBQWxDLElBQWdEUixNQUFNLENBQUNLLEVBQVAsQ0FBVUMsVUFBVixJQUF3QkMsU0FBUyxDQUFDRSxJ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YnNvY2tldCBcclxuICovXHJcblxyXG5sZXQgR2xvYmFsID0gcmVxdWlyZShcImNvbW1vblwiKVxyXG4vL2xldCBQbGF5ZXIgPSByZXF1aXJlKFwiUGxheWVyXCIpXHJcblxyXG5jYy5DbGFzcyh7XHJcbiAgICAvL2V4dGVuZHM6IGNjLkNvbXBvbmVudCxcclxuXHJcbiAgICAvKlxyXG4gICAgcmVhZHlTdGF0ZTpcclxuICAgICAgICBDT05ORUNUSU5HIDBcclxuICAgICAgICBPUEVOICAgICAgIDFcclxuICAgICAgICBDTE9TSU5HICAgIDJcclxuICAgICAgICBDTE9TRUQgICAgIDNcclxuICAgICovXHJcbiAgIFxyXG4gICAgQ2FuU2VuZE1zZzogZnVuY3Rpb24oKXtcclxuICAgICAgICBpZiAoR2xvYmFsLndzID09IG51bGwpe1xyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2VcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiAoR2xvYmFsLndzLnJlYWR5U3RhdGUgPT0gV2ViU29ja2V0LkNPTk5FQ1RJTkcgfHwgR2xvYmFsLndzLnJlYWR5U3RhdGUgPT0gV2ViU29ja2V0Lk9QRU4pXHJcbiAgICB9LCAgXHJcblxyXG4gICAgbmV3UGxheWVyOiBmdW5jdGlvbihhcnJEYXRhKXtcclxuICAgICAgICBHbG9iYWwubmV3cGxheWVyQ3JlYXRlZCA9IDFcclxuICAgICAgICBHbG9iYWwubmV3cGxheWVyUG9zeCA9IGFyckRhdGFbNF1cclxuICAgICAgICBpZiAoYXJyRGF0YVszXSA9PSAyKSB7XHJcbiAgICAgICAgICAgIEdsb2JhbC5uZXdwbGF5ZXJQb3N4ID0gMCAtIEdsb2JhbC5uZXdwbGF5ZXJQb3N4XHJcbiAgICAgICAgfVxyXG4gICAgICAgIEdsb2JhbC5uZXdwbGF5ZXJQb3N5ID0gYXJyRGF0YVs2XVxyXG4gICAgICAgIGlmIChhcnJEYXRhWzVdID09IDIpIHtcclxuICAgICAgICAgICAgR2xvYmFsLm5ld3BsYXllclBvc3kgPSAwIC0gR2xvYmFsLm5ld3BsYXllclBvc3lcclxuICAgICAgICB9XHJcbiAgICB9LFxyXG5cclxuICAgIHN3Q29ubmVjdDogZnVuY3Rpb24oKXtcclxuICAgICAgICBpZiAoR2xvYmFsLndzICE9IG51bGwpIHtcclxuICAgICAgICAgICAgcmV0dXJuXHJcbiAgICAgICAgICAgIGNjLmxvZyhcInJlYWR5U3RhdGU6IFwiLCBHbG9iYWwud3MucmVhZHlTdGF0ZSlcclxuICAgICAgICAgICAgaWYgKEdsb2JhbC53cy5yZWFkeVN0YXRlID09IFdlYlNvY2tldC5DT05ORUNUSU5HIHx8IEdsb2JhbC53cy5yZWFkeVN0YXRlID09IFdlYlNvY2tldC5PUEVOKSB7IC8v5bey57uP6L+e5LiK5bCx5LiN5b+F5YaN6L+eXHJcbiAgICAgICAgICAgICAgICByZXR1cm5cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY2MubG9nKFwiYWRkcjogXCIsIEdsb2JhbC53c0FkZHIsIEdsb2JhbC53cyA9PSBudWxsKVxyXG4gICAgICAgIHZhciB3cyA9IG5ldyBXZWJTb2NrZXQoR2xvYmFsLndzQWRkcik7XHJcbiAgICAgICAgd3Mub25vcGVuID0gZnVuY3Rpb24oZSkge1xyXG4gICAgICAgICAgICBjYy5sb2coXCJ3cyBvcGVuOiBcIiwgd3MucmVhZHlTdGF0ZSlcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHdzLm9ubWVzc2FnZSA9IGZ1bmN0aW9uKGUpIHtcclxuICAgICAgICAgICAgLyoqXHJcbiAgICAgICAgICAgICAqIOa2iOaBr+ino+aekCBcclxuICAgICAgICAgICAgICogMDog5raI5oGvaWRcclxuICAgICAgICAgICAgICogMe+8mua2iOaBr+mVv+W6plxyXG4gICAgICAgICAgICAgKiAy77yac2Vzc2lvbmlkXHJcbiAgICAgICAgICAgICAqIDPvvJpub2RleCB45Z2Q5qCH5q2j6LSf5qCH6K6wXHJcbiAgICAgICAgICAgICAqIDTvvJpub2RleCB45Z2Q5qCH5YC8XHJcbiAgICAgICAgICAgICAqIDXvvJpub2RleSB55Z2Q5qCH5q2j6LSf5qCH6K6wXHJcbiAgICAgICAgICAgICAqIDbvvJpub2RleSB55Z2Q5qCH5YC8IFxyXG4gICAgICAgICAgICAgKi9cclxuICAgICAgICAgICAgdmFyIGRhdGEgPSBuZXcgVWludDMyQXJyYXkoZS5kYXRhKVxyXG4gICAgICAgICAgICB2YXIgbXNnaWQgPSBkYXRhWzBdIFxyXG4gICAgICAgICAgICBzd2l0Y2ggKG1zZ2lkKSB7XHJcbiAgICAgICAgICAgICAgICBjYXNlIEdsb2JhbC5NSURfbG9naW46XHJcbiAgICAgICAgICAgICAgICAgICAgY2MubG9nKFwid3MgbWVzc2FnZSBNSURfbG9naW46IFwiLCBkYXRhWzFdLCBkYXRhWzJdLCBkYXRhWzNdLCBkYXRhWzRdLCBkYXRhWzVdLCBkYXRhWzZdKVxyXG4gICAgICAgICAgICAgICAgICAgIHZhciBrZXkgPSBkYXRhWzJdLnRvU3RyaW5nKClcclxuICAgICAgICAgICAgICAgICAgICB2YXIgbm9kZXggPSBkYXRhWzRdXHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIG5vZGV5ID0gZGF0YVs2XVxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChkYXRhWzNdID09IDIpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBub2RleCA9IDAgLSBub2RleFxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YVs1XSA9PSAyKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbm9kZXkgPSAwIC0gbm9kZXlcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIHBsYXllclByb3AgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlc3Npb25JZDogZGF0YVsyXSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgbm9kZXg6IG5vZGV4LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBub2RleTogbm9kZXlcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKEdsb2JhbC5QbGF5ZXJTZXNzaW9uTWFwLmhhcyhrZXkpID09IGZhbHNlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIEdsb2JhbC5QbGF5ZXJTZXNzaW9uTWFwLnNldChrZXksIHBsYXllclByb3ApXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIEdsb2JhbC5OZXdwbGF5ZXJNYXAuc2V0KGtleSwgcGxheWVyUHJvcClcclxuICAgICAgICAgICAgICAgICAgICBHbG9iYWwubmV3UGxheWVySWRzLnB1c2goa2V5KVxyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSBHbG9iYWwuTUlEX2xvZ291dDpcclxuICAgICAgICAgICAgICAgICAgICB2YXIga2V5ID0gZGF0YVsyXS50b1N0cmluZygpXHJcbiAgICAgICAgICAgICAgICAgICAgY2MubG9nKFwid3MgbWVzc2FnZSBNSURfbG9nb3V0LCBzZXNzaW9uaWQ6IFwiLCBrZXkpXHJcbiAgICAgICAgICAgICAgICAgICAgR2xvYmFsLkRlbFBsYXllcklkcy5wdXNoKGtleSlcclxuICAgICAgICAgICAgICAgICAgICBHbG9iYWwuUGxheWVyU2Vzc2lvbk1hcC5kZWxldGUoa2V5KVxyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSBHbG9iYWwuTUlEX21vdmU6XHJcbiAgICAgICAgICAgICAgICAgICAgY2MubG9nKFwid3MgbWVzc2FnZSBNSURfbW92ZTogXCIsIGRhdGFbMV0sIGRhdGFbMl0sIGRhdGFbM10sIGRhdGFbNF0sIGRhdGFbNV0sIGRhdGFbNl0pXHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGtleSA9IGRhdGFbMl0udG9TdHJpbmcoKVxyXG4gICAgICAgICAgICAgICAgICAgIHZhciBub2RleCA9IGRhdGFbNF1cclxuICAgICAgICAgICAgICAgICAgICB2YXIgbm9kZXkgPSBkYXRhWzZdXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGFbM10gPT0gMil7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGV4ID0gMCAtIG5vZGV4XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChkYXRhWzVdID09IDIpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBub2RleSA9IDAgLSBub2RleVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB2YXIgcGxheWVyUHJvcCA9IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc2Vzc2lvbklkOiBkYXRhWzJdLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBub2RleDogbm9kZXgsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGV5OiBub2RleVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBpZiAoR2xvYmFsLlBsYXllclNlc3Npb25NYXAuaGFzKGtleSkgPT0gZmFsc2UpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgR2xvYmFsLlBsYXllclNlc3Npb25NYXAuc2V0KGtleSwgcGxheWVyUHJvcClcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgR2xvYmFsLk5ld3BsYXllck1hcC5zZXQoa2V5LCBwbGF5ZXJQcm9wKVxyXG4gICAgICAgICAgICAgICAgICAgIEdsb2JhbC5uZXdQbGF5ZXJJZHMucHVzaChrZXkpXHJcbiAgICAgICAgICAgICAgICAgICAgY2MubG9nKFwiTUlEX21vdmUgcHVycGxlIG1vbnN0ZXJzOiBcIiwgR2xvYmFsLm5ld1BsYXllcklkcy5sZW5ndGgpXHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgICAgIGNjLmxvZyhcIuacquefpSDmtojmga9pZDogXCIsIG1zZ2lkKVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB3cy5vbmVycm9yID0gZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICAgICAgY2MubG9nKFwid3MgZXJyb3I6IFwiLCB3cy5yZWFkeVN0YXRlKVxyXG4gICAgICAgICAgICBHbG9iYWwud3MgPSBudWxsXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB3cy5vbmNsb3NlID0gZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICAgICAgY2MubG9nKFwid3MgY2xvc2U6IFwiLCB3cy5yZWFkeVN0YXRlKVxyXG4gICAgICAgICAgICAvL1BsYXllci5zZW5kUGxheWVyUG9zKClcclxuICAgICAgICAgICAgR2xvYmFsLndzID0gbnVsbFxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY2MubG9nKFwiZ2xvYmFsIHdzIGluaXQsIHN0YXRlOiBcIiwgd3MucmVhZHlTdGF0ZSlcclxuICAgICAgICBHbG9iYWwud3MgPSB3c1xyXG4gICAgfSxcclxuXHJcbiAgICAvKipcclxuICAgICAqIFxyXG4gICAgICogQHBhcmFtIHsqfSBkYXRhICDlhbfkvZPmlbDmja4sIDHvvJrplb/luqbvvIwy77ya5piv5ZCm5bm/5pKt77yMM++8mi4uLiDlhbfkvZPmtojmga/mlbDmja5cclxuICAgICAqL1xyXG4gICAgc2VuZHdzbWVzc2FnZTogZnVuY3Rpb24oZGF0YSl7XHJcbiAgICAgICAgXHJcbiAgICAgICAgaWYgKEdsb2JhbC53cyA9PSBudWxsKSB7XHJcbiAgICAgICAgICAgIHJldHVyblxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKEdsb2JhbC53cyAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgIGlmIChHbG9iYWwud3MucmVhZHlTdGF0ZSA9PSBXZWJTb2NrZXQuQ0xPU0VEIHx8IEdsb2JhbC53cy5yZWFkeVN0YXRlID09IFdlYlNvY2tldC5DTE9TSU5HKSB7IC8v5q2j5Zyo5pat5byA5oiW6ICF5bey57uP5pat5byA77yM5YiZ5LiN6IO95Y+R6YCB5raI5oGvXHJcbiAgICAgICAgICAgICAgICByZXR1cm5cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY2MubG9nKFwid3Mgc2VuZHdzbWVzc2FnZTogXCIsIEdsb2JhbC53cy5yZWFkeVN0YXRlKVxyXG4gICAgICAgIEdsb2JhbC53cy5zZW5kKGRhdGEpXHJcbiAgICB9XHJcbn0pIl19