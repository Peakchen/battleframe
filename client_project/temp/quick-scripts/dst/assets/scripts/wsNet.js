
                (function() {
                    var nodeEnv = typeof require !== 'undefined' && typeof process !== 'undefined';
                    var __module = nodeEnv ? module : {exports:{}};
                    var __filename = 'preview-scripts/assets/scripts/wsNet.js';
                    var __require = nodeEnv ? function (request) {
                        return cc.require(request);
                    } : function (request) {
                        return __quick_compile_project__.require(request, __filename);
                    };
                    function __define (exports, require, module) {
                        if (!nodeEnv) {__quick_compile_project__.registerModule(__filename, module);}"use strict";
cc._RF.push(module, 'f5f02ULtVhD47PNH08lZ5uR', 'wsNet');
// scripts/wsNet.js

"use strict";

/**
 * websocket 
 */
var Global = require("common"); //心跳检测


var HeartCheck = {
  timeout: 1000,
  //60秒
  timeoutObj: null,
  serverTimeoutObj: null,
  disconnectioned: false,
  reconnectTimeoutobj: null,
  state: null,
  //websocket state
  reset: function reset() {
    clearTimeout(this.timeoutObj);
    clearTimeout(this.serverTimeoutObj);
    return this;
  },
  startHeartBeat: function startHeartBeat() {
    var self = this;
    this.timeoutObj = setTimeout(function () {
      //这里发送一个心跳，后端收到后，返回一个心跳消息，onmessage拿到返回的心跳就说明连接正常
      cc.log("send heart beat...");

      if (Global.ws == null) {
        return;
      }

      var buff = new ArrayBuffer(12);
      var data = new Uint32Array(buff);
      data[0] = Global.MID_HeartBeat; //消息ID

      data[1] = 1; //消息长度

      data[2] = 0; //anything 随意填充一个数

      Global.ws.send(data);
      self.serverTimeoutObj = setTimeout(function () {
        //心跳超时主动断开
        cc.log("close connection...");

        if (Global.ws == null) {
          return;
        }

        Global.ws.close();
        self.disconnectioned = true;
      }, self.timeout);
    }, this.timeout);
  },
  startCheckStopHeartBeat: function startCheckStopHeartBeat() {},
  hasDisconnected: function hasDisconnected() {
    return this.disconnectioned;
  },
  stopReconnectTimer: function stopReconnectTimer() {
    cc.log("close reconnectTimeout...");
    clearTimeout(this.reconnectTimeoutobj);
  }
};
cc.Class({
  //extends: cc.Component,

  /*
  readyState:
      CONNECTING 0
      OPEN       1
      CLOSING    2
      CLOSED     3
  */
  CanSendMsg: function CanSendMsg() {
    if (Global.ws == null) {
      return false;
    }

    return Global.ws.readyState == WebSocket.CONNECTING || Global.ws.readyState == WebSocket.OPEN;
  },
  swConnect: function swConnect() {
    if (Global.ws != null) {
      //return
      cc.log("readyState: ", Global.ws.readyState);

      if (Global.ws.readyState == WebSocket.CONNECTING || Global.ws.readyState == WebSocket.OPEN) {
        //已经连上就不必再连
        return;
      }
    }

    var self = this;
    cc.log("addr: ", Global.wsAddr, Global.ws == null);
    var ws = new WebSocket(Global.wsAddr);

    ws.onopen = function (e) {
      cc.log("ws open: ", ws.readyState); //发送心跳

      HeartCheck.reset().startHeartBeat();
    };

    ws.onmessage = function (e) {
      /**
       * 消息解析 
       * 0: 消息id
       * 1：消息长度
       * 2：sessionid
       * 3：nodex x坐标正负标记
       * 4：nodex x坐标值
       * 5：nodey y坐标正负标记
       * 6：nodey y坐标值 
       */
      var data = new Uint32Array(e.data);
      var msgid = data[0];

      switch (msgid) {
        case Global.MID_login:
          cc.log("ws message MID_login: ", data[1], data[2], data[3], data[4], data[5], data[6]);
          var key = data[2].toString();
          var nodex = data[4];
          var nodey = data[6];

          if (data[3] == 2) {
            nodex = 0 - nodex;
          }

          if (data[5] == 2) {
            nodey = 0 - nodey;
          }

          var playerProp = {
            sessionId: data[2],
            nodex: nodex,
            nodey: nodey
          };

          if (Global.PlayerSessionMap.has(key) == false) {
            Global.PlayerSessionMap.set(key, playerProp);
          }

          Global.NewplayerMap.set(key, playerProp);
          Global.newPlayerIds.push(key);
          break;

        case Global.MID_logout:
          var key = data[2].toString();
          cc.log("ws message MID_logout, sessionid: ", key);
          Global.DelPlayerIds.push(key);
          Global.PlayerSessionMap["delete"](key);
          break;

        case Global.MID_move:
          cc.log("ws message MID_move: ", data[1], data[2], data[3], data[4], data[5], data[6]);
          var key = data[2].toString();
          var nodex = data[4];
          var nodey = data[6];

          if (data[3] == 2) {
            nodex = 0 - nodex;
          }

          if (data[5] == 2) {
            nodey = 0 - nodey;
          }

          var playerProp = {
            sessionId: data[2],
            nodex: nodex,
            nodey: nodey
          };

          if (Global.PlayerSessionMap.has(key) == false) {
            Global.PlayerSessionMap.set(key, playerProp);
          }

          Global.NewplayerMap.set(key, playerProp);
          Global.newPlayerIds.push(key);
          cc.log("MID_move purple monsters: ", Global.newPlayerIds.length);
          break;

        case Global.MID_Bump:
          //cc.log("ws message MID_Bump: ", data[1], data[2], data[3], data[4], data[5], data[6])

          /**
           *  0: 消息ID
              1：消息长度
              2: 成功失败标志 (失败则只需要前三个字段)
              3: 星星x坐标正负标志
              4: 星星x坐标
              5：星星y坐标正负标志
              6：星星y坐标
           */
          if (data[2] == 0) {
            //失败
            cc.log("ws message MID_Bump fail ... ");
            break;
          }

          var nodex = data[4];
          var nodey = data[6];

          if (data[3] == 2) {
            nodex = 0 - nodex;
          }

          if (data[5] == 2) {
            nodey = 0 - nodey;
          }

          var starProp = {
            nodex: nodex,
            nodey: nodey
          };
          Global.newStarPos.set(Global.newStarKey, starProp);
          break;

        case Global.MID_HeartBeat:
          cc.log("ws message MID_HeartBeat: ", msgid);
          break;

        default:
          cc.log("未知 消息id: ", msgid);
      } //发送心跳


      HeartCheck.reset().startHeartBeat();
    };

    ws.onerror = function (e) {
      cc.log("ws error: ", ws.readyState); //Global.ws = null

      if (HeartCheck.hasDisconnected() == false) {
        HeartCheck.stopReconnectTimer();
        HeartCheck.reconnectTimeoutobj = setTimeout(function () {
          self.swConnect();
        }, 1000);
      } else {
        HeartCheck.stopReconnectTimer();
      }
    };

    ws.onclose = function (e) {
      cc.log("ws close: ", ws.readyState); //Global.ws = null

      if (HeartCheck.hasDisconnected() == false) {
        HeartCheck.stopReconnectTimer();
        HeartCheck.reconnectTimeoutobj = setTimeout(function () {
          self.swConnect();
        }, 1000);
      } else {
        HeartCheck.stopReconnectTimer();
      }
    };

    cc.log("global ws init, state: ", ws.readyState);
    Global.ws = ws;
  },

  /**
   * 
   * @param {*} data  具体数据, 1：长度，2：是否广播，3：... 具体消息数据
   */
  sendwsmessage: function sendwsmessage(data) {
    if (Global.ws == null) {
      return;
    }

    if (Global.ws != null) {
      if (Global.ws.readyState == WebSocket.CLOSED || Global.ws.readyState == WebSocket.CLOSING) {
        //正在断开或者已经断开，则不能发送消息
        return;
      }
    } //cc.log("ws sendwsmessage: ", Global.ws.readyState)


    Global.ws.send(data);
  }
});

cc._RF.pop();
                    }
                    if (nodeEnv) {
                        __define(__module.exports, __require, __module);
                    }
                    else {
                        __quick_compile_project__.registerModuleFunc(__filename, function () {
                            __define(__module.exports, __require, __module);
                        });
                    }
                })();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFzc2V0c1xcc2NyaXB0c1xcd3NOZXQuanMiXSwibmFtZXMiOlsiR2xvYmFsIiwicmVxdWlyZSIsIkhlYXJ0Q2hlY2siLCJ0aW1lb3V0IiwidGltZW91dE9iaiIsInNlcnZlclRpbWVvdXRPYmoiLCJkaXNjb25uZWN0aW9uZWQiLCJyZWNvbm5lY3RUaW1lb3V0b2JqIiwic3RhdGUiLCJyZXNldCIsImNsZWFyVGltZW91dCIsInN0YXJ0SGVhcnRCZWF0Iiwic2VsZiIsInNldFRpbWVvdXQiLCJjYyIsImxvZyIsIndzIiwiYnVmZiIsIkFycmF5QnVmZmVyIiwiZGF0YSIsIlVpbnQzMkFycmF5IiwiTUlEX0hlYXJ0QmVhdCIsInNlbmQiLCJjbG9zZSIsInN0YXJ0Q2hlY2tTdG9wSGVhcnRCZWF0IiwiaGFzRGlzY29ubmVjdGVkIiwic3RvcFJlY29ubmVjdFRpbWVyIiwiQ2xhc3MiLCJDYW5TZW5kTXNnIiwicmVhZHlTdGF0ZSIsIldlYlNvY2tldCIsIkNPTk5FQ1RJTkciLCJPUEVOIiwic3dDb25uZWN0Iiwid3NBZGRyIiwib25vcGVuIiwiZSIsIm9ubWVzc2FnZSIsIm1zZ2lkIiwiTUlEX2xvZ2luIiwia2V5IiwidG9TdHJpbmciLCJub2RleCIsIm5vZGV5IiwicGxheWVyUHJvcCIsInNlc3Npb25JZCIsIlBsYXllclNlc3Npb25NYXAiLCJoYXMiLCJzZXQiLCJOZXdwbGF5ZXJNYXAiLCJuZXdQbGF5ZXJJZHMiLCJwdXNoIiwiTUlEX2xvZ291dCIsIkRlbFBsYXllcklkcyIsIk1JRF9tb3ZlIiwibGVuZ3RoIiwiTUlEX0J1bXAiLCJzdGFyUHJvcCIsIm5ld1N0YXJQb3MiLCJuZXdTdGFyS2V5Iiwib25lcnJvciIsIm9uY2xvc2UiLCJzZW5kd3NtZXNzYWdlIiwiQ0xPU0VEIiwiQ0xPU0lORyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQTs7O0FBSUEsSUFBSUEsTUFBTSxHQUFHQyxPQUFPLENBQUMsUUFBRCxDQUFwQixFQUVBOzs7QUFDQSxJ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QUNxQixTQUFMO0FBQ0gsU0FGMEMsRUFFeEMsSUFGd0MsQ0FBM0M7QUFHSCxPQUxELE1BS0s7QUFDRC9CLFFBQUFBLFVBQVUsQ0FBQ3dCLGtCQUFYO0FBQ0g7QUFDSixLQVhEOztBQWFBWixJQUFBQSxFQUFFLENBQUNDLEdBQUgsQ0FBTyx5QkFBUCxFQUFrQ0MsRUFBRSxDQUFDYSxVQUFyQztBQUNBN0IsSUFBQUEsTUFBTSxDQUFDZ0IsRUFBUCxHQUFZQSxFQUFaO0FBQ0gsR0E5S0k7O0FBZ0xMOzs7O0FBSUE4QyxFQUFBQSxhQUFhLEVBQUUsdUJBQVMzQyxJQUFULEVBQWM7QUFFekIsUUFBSW5CLE1BQU0sQ0FBQ2dCLEVBQVAsSUFBYSxJQUFqQixFQUF1QjtBQUNuQjtBQUNIOztBQUVELFFBQUloQixNQUFNLENBQUNnQixFQUFQLElBQWEsSUFBakIsRUFBdUI7QUFDbkIsVUFBSWhCLE1BQU0sQ0FBQ2dCLEVBQVAsQ0FBVWEsVUFBVixJQUF3QkMsU0FBUyxDQUFDaUMsTUFBbEMsSUFBNEMvRCxNQUFNLENBQUNnQixFQUFQLENBQVVhLFVBQVYsSUFBd0JDLFNBQVMsQ0FBQ2tDLE9BQWxGLEVBQTJGO0FBQUU7QUFDekY7QUFDSDtBQUNKLEtBVndCLENBWXpCOzs7QUFDQWhFLElBQUFBLE1BQU0sQ0FBQ2dCLEVBQVAsQ0FBVU0sSUFBVixDQUFlSCxJQUFmO0FBQ0g7QUFsTUksQ0FBVCIsInNvdXJjZVJvb3QiOiIvIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIHdlYnNvY2tldCBcclxuICovXHJcblxyXG5sZXQgR2xvYmFsID0gcmVxdWlyZShcImNvbW1vblwiKVxyXG5cclxuLy/lv4Pot7Pmo4DmtYtcclxudmFyIEhlYXJ0Q2hlY2sgPSB7XHJcbiAgICB0aW1lb3V0OiAxMDAwLCAvLzYw56eSXHJcbiAgICB0aW1lb3V0T2JqOiBudWxsLFxyXG4gICAgc2VydmVyVGltZW91dE9iajogbnVsbCxcclxuICAgIGRpc2Nvbm5lY3Rpb25lZDogZmFsc2UsXHJcbiAgICByZWNvbm5lY3RUaW1lb3V0b2JqOiBudWxsLFxyXG4gICAgc3RhdGU6IG51bGwsICAgIC8vd2Vic29ja2V0IHN0YXRlXHJcblxyXG4gICAgcmVzZXQ6IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIGNsZWFyVGltZW91dCh0aGlzLnRpbWVvdXRPYmopO1xyXG4gICAgICAgIGNsZWFyVGltZW91dCh0aGlzLnNlcnZlclRpbWVvdXRPYmopO1xyXG4gICAgICAgIHJldHVybiB0aGlzO1xyXG4gICAgfSxcclxuXHJcbiAgICBzdGFydEhlYXJ0QmVhdDogZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgdmFyIHNlbGYgPSB0aGlzO1xyXG4gICAgICAgIHRoaXMudGltZW91dE9iaiA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgIC8v6L+Z6YeM5Y+R6YCB5LiA5Liq5b+D6Lez77yM5ZCO56uv5pS25Yiw5ZCO77yM6L+U5Zue5LiA5Liq5b+D6Lez5raI5oGv77yMb25tZXNzYWdl5ou/5Yiw6L+U5Zue55qE5b+D6Lez5bCx6K+05piO6L+e5o6l5q2j5bi4XHJcbiAgICAgICAgICAgIGNjLmxvZyhcInNlbmQgaGVhcnQgYmVhdC4uLlwiKVxyXG4gICAgICAgICAgICBpZiAoR2xvYmFsLndzID09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgIHJldHVyblxyXG4gICAgICAgICAgICB9IFxyXG5cclxuICAgICAgICAgICAgdmFyIGJ1ZmYgPSBuZXcgQXJyYXlCdWZmZXIoMTIpXHJcbiAgICAgICAgICAgIHZhciBkYXRhID0gbmV3IFVpbnQzMkFycmF5KGJ1ZmYpXHJcbiAgICBcclxuICAgICAgICAgICAgZGF0YVswXSA9IEdsb2JhbC5NSURfSGVhcnRCZWF0IC8v5raI5oGvSURcclxuICAgICAgICAgICAgZGF0YVsxXSA9IDEgLy/mtojmga/plb/luqZcclxuICAgICAgICAgICAgZGF0YVsyXSA9IDAgLy9hbnl0aGluZyDpmo/mhI/loavlhYXkuIDkuKrmlbBcclxuXHJcbiAgICAgICAgICAgIEdsb2JhbC53cy5zZW5kKGRhdGEpO1xyXG4gICAgICAgICAgICBzZWxmLnNlcnZlclRpbWVvdXRPYmogPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgeyAvL+W/g+i3s+i2heaXtuS4u+WKqOaWreW8gFxyXG4gICAgICAgICAgICAgICAgY2MubG9nKFwiY2xvc2UgY29ubmVjdGlvbi4uLlwiKVxyXG4gICAgICAgICAgICAgICAgaWYgKEdsb2JhbC53cyA9PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuXHJcbiAgICAgICAgICAgICAgICB9IFxyXG4gICAgICAgICAgICAgICAgR2xvYmFsLndzLmNsb3NlKCk7XHJcbiAgICAgICAgICAgICAgICBzZWxmLmRpc2Nvbm5lY3Rpb25lZCA9IHRydWVcclxuICAgICAgICAgICAgfSwgc2VsZi50aW1lb3V0KVxyXG4gICAgICAgIH0sIHRoaXMudGltZW91dClcclxuICAgIH0sXHJcblxyXG4gICAgc3RhcnRDaGVja1N0b3BIZWFydEJlYXQ6IGZ1bmN0aW9uKCl7XHJcblxyXG4gICAgfSxcclxuXHJcbiAgICBoYXNEaXNjb25uZWN0ZWQ6IGZ1bmN0aW9uKCl7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZGlzY29ubmVjdGlvbmVkXHJcbiAgICB9LFxyXG5cclxuICAgIHN0b3BSZWNvbm5lY3RUaW1lcjogZnVuY3Rpb24oKXtcclxuICAgICAgICBjYy5sb2coXCJjbG9zZSByZWNvbm5lY3RUaW1lb3V0Li4uXCIpXHJcbiAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMucmVjb25uZWN0VGltZW91dG9iaik7XHJcbiAgICB9XHJcbn1cclxuXHJcbmNjLkNsYXNzKHtcclxuICAgIC8vZXh0ZW5kczogY2MuQ29tcG9uZW50LFxyXG5cclxuICAgIC8qXHJcbiAgICByZWFkeVN0YXRlOlxyXG4gICAgICAgIENPTk5FQ1RJTkcgMFxyXG4gICAgICAgIE9QRU4gICAgICAgMVxyXG4gICAgICAgIENMT1NJTkcgICAgMlxyXG4gICAgICAgIENMT1NFRCAgICAgM1xyXG4gICAgKi9cclxuICAgXHJcbiAgICBDYW5TZW5kTXNnOiBmdW5jdGlvbigpe1xyXG4gICAgICAgIGlmIChHbG9iYWwud3MgPT0gbnVsbCl7XHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIChHbG9iYWwud3MucmVhZHlTdGF0ZSA9PSBXZWJTb2NrZXQuQ09OTkVDVElORyB8fCBHbG9iYWwud3MucmVhZHlTdGF0ZSA9PSBXZWJTb2NrZXQuT1BFTilcclxuICAgIH0sIFxyXG5cclxuICAgIHN3Q29ubmVjdDogZnVuY3Rpb24oKXtcclxuICAgICAgICBpZiAoR2xvYmFsLndzICE9IG51bGwpIHtcclxuICAgICAgICAgICAgLy9yZXR1cm5cclxuICAgICAgICAgICAgY2MubG9nKFwicmVhZHlTdGF0ZTogXCIsIEdsb2JhbC53cy5yZWFkeVN0YXRlKVxyXG4gICAgICAgICAgICBpZiAoR2xvYmFsLndzLnJlYWR5U3RhdGUgPT0gV2ViU29ja2V0LkNPTk5FQ1RJTkcgfHwgR2xvYmFsLndzLnJlYWR5U3RhdGUgPT0gV2ViU29ja2V0Lk9QRU4pIHsgLy/lt7Lnu4/ov57kuIrlsLHkuI3lv4Xlho3ov55cclxuICAgICAgICAgICAgICAgIHJldHVyblxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB2YXIgc2VsZiA9IHRoaXM7XHJcbiAgICAgICAgY2MubG9nKFwiYWRkcjogXCIsIEdsb2JhbC53c0FkZHIsIEdsb2JhbC53cyA9PSBudWxsKVxyXG4gICAgICAgIHZhciB3cyA9IG5ldyBXZWJTb2NrZXQoR2xvYmFsLndzQWRkcik7XHJcbiAgICAgICAgd3Mub25vcGVuID0gZnVuY3Rpb24oZSkge1xyXG4gICAgICAgICAgICBjYy5sb2coXCJ3cyBvcGVuOiBcIiwgd3MucmVhZHlTdGF0ZSlcclxuICAgICAgICAgICAgLy/lj5HpgIHlv4Pot7NcclxuICAgICAgICAgICAgSGVhcnRDaGVjay5yZXNldCgpLnN0YXJ0SGVhcnRCZWF0KClcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHdzLm9ubWVzc2FnZSA9IGZ1bmN0aW9uKGUpIHtcclxuICAgICAgICAgICAgLyoqXHJcbiAgICAgICAgICAgICAqIOa2iOaBr+ino+aekCBcclxuICAgICAgICAgICAgICogMDog5raI5oGvaWRcclxuICAgICAgICAgICAgICogMe+8mua2iOaBr+mVv+W6plxyXG4gICAgICAgICAgICAgKiAy77yac2Vzc2lvbmlkXHJcbiAgICAgICAgICAgICAqIDPvvJpub2RleCB45Z2Q5qCH5q2j6LSf5qCH6K6wXHJcbiAgICAgICAgICAgICAqIDTvvJpub2RleCB45Z2Q5qCH5YC8XHJcbiAgICAgICAgICAgICAqIDXvvJpub2RleSB55Z2Q5qCH5q2j6LSf5qCH6K6wXHJcbiAgICAgICAgICAgICAqIDbvvJpub2RleSB55Z2Q5qCH5YC8IFxyXG4gICAgICAgICAgICAgKi9cclxuXHJcbiAgICAgICAgICAgIHZhciBkYXRhID0gbmV3IFVpbnQzMkFycmF5KGUuZGF0YSlcclxuICAgICAgICAgICAgdmFyIG1zZ2lkID0gZGF0YVswXSBcclxuICAgICAgICAgICAgc3dpdGNoIChtc2dpZCkge1xyXG4gICAgICAgICAgICAgICAgY2FzZSBHbG9iYWwuTUlEX2xvZ2luOlxyXG4gICAgICAgICAgICAgICAgICAgIGNjLmxvZyhcIndzIG1lc3NhZ2UgTUlEX2xvZ2luOiBcIiwgZGF0YVsxXSwgZGF0YVsyXSwgZGF0YVszXSwgZGF0YVs0XSwgZGF0YVs1XSwgZGF0YVs2XSlcclxuICAgICAgICAgICAgICAgICAgICB2YXIga2V5ID0gZGF0YVsyXS50b1N0cmluZygpXHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIG5vZGV4ID0gZGF0YVs0XVxyXG4gICAgICAgICAgICAgICAgICAgIHZhciBub2RleSA9IGRhdGFbNl1cclxuICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YVszXSA9PSAyKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbm9kZXggPSAwIC0gbm9kZXhcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGFbNV0gPT0gMil7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGV5ID0gMCAtIG5vZGV5XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIHZhciBwbGF5ZXJQcm9wID0ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzZXNzaW9uSWQ6IGRhdGFbMl0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGV4OiBub2RleCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgbm9kZXk6IG5vZGV5XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChHbG9iYWwuUGxheWVyU2Vzc2lvbk1hcC5oYXMoa2V5KSA9PSBmYWxzZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBHbG9iYWwuUGxheWVyU2Vzc2lvbk1hcC5zZXQoa2V5LCBwbGF5ZXJQcm9wKVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBHbG9iYWwuTmV3cGxheWVyTWFwLnNldChrZXksIHBsYXllclByb3ApXHJcbiAgICAgICAgICAgICAgICAgICAgR2xvYmFsLm5ld1BsYXllcklkcy5wdXNoKGtleSlcclxuICAgICAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UgR2xvYmFsLk1JRF9sb2dvdXQ6XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGtleSA9IGRhdGFbMl0udG9TdHJpbmcoKVxyXG4gICAgICAgICAgICAgICAgICAgIGNjLmxvZyhcIndzIG1lc3NhZ2UgTUlEX2xvZ291dCwgc2Vzc2lvbmlkOiBcIiwga2V5KVxyXG4gICAgICAgICAgICAgICAgICAgIEdsb2JhbC5EZWxQbGF5ZXJJZHMucHVzaChrZXkpXHJcbiAgICAgICAgICAgICAgICAgICAgR2xvYmFsLlBsYXllclNlc3Npb25NYXAuZGVsZXRlKGtleSlcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UgR2xvYmFsLk1JRF9tb3ZlOlxyXG4gICAgICAgICAgICAgICAgICAgIGNjLmxvZyhcIndzIG1lc3NhZ2UgTUlEX21vdmU6IFwiLCBkYXRhWzFdLCBkYXRhWzJdLCBkYXRhWzNdLCBkYXRhWzRdLCBkYXRhWzVdLCBkYXRhWzZdKVxyXG4gICAgICAgICAgICAgICAgICAgIHZhciBrZXkgPSBkYXRhWzJdLnRvU3RyaW5nKClcclxuICAgICAgICAgICAgICAgICAgICB2YXIgbm9kZXggPSBkYXRhWzRdXHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIG5vZGV5ID0gZGF0YVs2XVxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChkYXRhWzNdID09IDIpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBub2RleCA9IDAgLSBub2RleFxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YVs1XSA9PSAyKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbm9kZXkgPSAwIC0gbm9kZXlcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIHBsYXllclByb3AgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlc3Npb25JZDogZGF0YVsyXSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgbm9kZXg6IG5vZGV4LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBub2RleTogbm9kZXlcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKEdsb2JhbC5QbGF5ZXJTZXNzaW9uTWFwLmhhcyhrZXkpID09IGZhbHNlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIEdsb2JhbC5QbGF5ZXJTZXNzaW9uTWFwLnNldChrZXksIHBsYXllclByb3ApXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIEdsb2JhbC5OZXdwbGF5ZXJNYXAuc2V0KGtleSwgcGxheWVyUHJvcClcclxuICAgICAgICAgICAgICAgICAgICBHbG9iYWwubmV3UGxheWVySWRzLnB1c2goa2V5KVxyXG4gICAgICAgICAgICAgICAgICAgIGNjLmxvZyhcIk1JRF9tb3ZlIHB1cnBsZSBtb25zdGVyczogXCIsIEdsb2JhbC5uZXdQbGF5ZXJJZHMubGVuZ3RoKVxyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSBHbG9iYWwuTUlEX0J1bXA6XHJcbiAgICAgICAgICAgICAgICAgICAgLy9jYy5sb2coXCJ3cyBtZXNzYWdlIE1JRF9CdW1wOiBcIiwgZGF0YVsxXSwgZGF0YVsyXSwgZGF0YVszXSwgZGF0YVs0XSwgZGF0YVs1XSwgZGF0YVs2XSlcclxuICAgICAgICAgICAgICAgICAgICAvKipcclxuICAgICAgICAgICAgICAgICAgICAgKiAgMDog5raI5oGvSURcclxuICAgICAgICAgICAgICAgICAgICAgICAgMe+8mua2iOaBr+mVv+W6plxyXG4gICAgICAgICAgICAgICAgICAgICAgICAyOiDmiJDlip/lpLHotKXmoIflv5cgKOWksei0peWImeWPqumcgOimgeWJjeS4ieS4quWtl+autSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgMzog5pif5pifeOWdkOagh+ato+i0n+agh+W/l1xyXG4gICAgICAgICAgICAgICAgICAgICAgICA0OiDmmJ/mmJ945Z2Q5qCHXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIDXvvJrmmJ/mmJ955Z2Q5qCH5q2j6LSf5qCH5b+XXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIDbvvJrmmJ/mmJ955Z2Q5qCHXHJcbiAgICAgICAgICAgICAgICAgICAgICovXHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChkYXRhWzJdID09IDApeyAvL+Wksei0pVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYy5sb2coXCJ3cyBtZXNzYWdlIE1JRF9CdW1wIGZhaWwgLi4uIFwiKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBicmVha1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgICAgICB2YXIgbm9kZXggPSBkYXRhWzRdXHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIG5vZGV5ID0gZGF0YVs2XVxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChkYXRhWzNdID09IDIpe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBub2RleCA9IDAgLSBub2RleFxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YVs1XSA9PSAyKXtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbm9kZXkgPSAwIC0gbm9kZXlcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIHN0YXJQcm9wID0ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBub2RleDogbm9kZXgsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGV5OiBub2RleVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBHbG9iYWwubmV3U3RhclBvcy5zZXQoR2xvYmFsLm5ld1N0YXJLZXksIHN0YXJQcm9wKVxyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrXHJcbiAgICAgICAgICAgICAgICBjYXNlIEdsb2JhbC5NSURfSGVhcnRCZWF0OlxyXG4gICAgICAgICAgICAgICAgICAgIGNjLmxvZyhcIndzIG1lc3NhZ2UgTUlEX0hlYXJ0QmVhdDogXCIsIG1zZ2lkKVxyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrXHJcbiAgICAgICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgICAgIGNjLmxvZyhcIuacquefpSDmtojmga9pZDogXCIsIG1zZ2lkKVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAvL+WPkemAgeW/g+i3s1xyXG4gICAgICAgICAgICBIZWFydENoZWNrLnJlc2V0KCkuc3RhcnRIZWFydEJlYXQoKVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgd3Mub25lcnJvciA9IGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgICAgIGNjLmxvZyhcIndzIGVycm9yOiBcIiwgd3MucmVhZHlTdGF0ZSlcclxuICAgICAgICAgICAgLy9HbG9iYWwud3MgPSBudWxsXHJcbiAgICAgICAgICAgIGlmIChIZWFydENoZWNrLmhhc0Rpc2Nvbm5lY3RlZCgpID09IGZhbHNlKSB7XHJcbiAgICAgICAgICAgICAgICBIZWFydENoZWNrLnN0b3BSZWNvbm5lY3RUaW1lcigpXHJcbiAgICAgICAgICAgICAgICBIZWFydENoZWNrLnJlY29ubmVjdFRpbWVvdXRvYmogPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHNlbGYuc3dDb25uZWN0KCk7XHJcbiAgICAgICAgICAgICAgICB9LCAxMDAwKVxyXG4gICAgICAgICAgICB9ZWxzZXtcclxuICAgICAgICAgICAgICAgIEhlYXJ0Q2hlY2suc3RvcFJlY29ubmVjdFRpbWVyKClcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgd3Mub25jbG9zZSA9IGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgICAgIGNjLmxvZyhcIndzIGNsb3NlOiBcIiwgd3MucmVhZHlTdGF0ZSlcclxuICAgICAgICAgICAgLy9HbG9iYWwud3MgPSBudWxsXHJcbiAgICAgICAgICAgIGlmIChIZWFydENoZWNrLmhhc0Rpc2Nvbm5lY3RlZCgpID09IGZhbHNlKSB7XHJcbiAgICAgICAgICAgICAgICBIZWFydENoZWNrLnN0b3BSZWNvbm5lY3RUaW1lcigpXHJcbiAgICAgICAgICAgICAgICBIZWFydENoZWNrLnJlY29ubmVjdFRpbWVvdXRvYmogPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHNlbGYuc3dDb25uZWN0KCk7XHJcbiAgICAgICAgICAgICAgICB9LCAxMDAwKVxyXG4gICAgICAgICAgICB9ZWxzZXtcclxuICAgICAgICAgICAgICAgIEhlYXJ0Q2hlY2suc3RvcFJlY29ubmVjdFRpbWVyKClcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY2MubG9nKFwiZ2xvYmFsIHdzIGluaXQsIHN0YXRlOiBcIiwgd3MucmVhZHlTdGF0ZSlcclxuICAgICAgICBHbG9iYWwud3MgPSB3c1xyXG4gICAgfSxcclxuXHJcbiAgICAvKipcclxuICAgICAqIFxyXG4gICAgICogQHBhcmFtIHsqfSBkYXRhICDlhbfkvZPmlbDmja4sIDHvvJrplb/luqbvvIwy77ya5piv5ZCm5bm/5pKt77yMM++8mi4uLiDlhbfkvZPmtojmga/mlbDmja5cclxuICAgICAqL1xyXG4gICAgc2VuZHdzbWVzc2FnZTogZnVuY3Rpb24oZGF0YSl7XHJcbiAgICAgICAgXHJcbiAgICAgICAgaWYgKEdsb2JhbC53cyA9PSBudWxsKSB7XHJcbiAgICAgICAgICAgIHJldHVyblxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKEdsb2JhbC53cyAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgIGlmIChHbG9iYWwud3MucmVhZHlTdGF0ZSA9PSBXZWJTb2NrZXQuQ0xPU0VEIHx8IEdsb2JhbC53cy5yZWFkeVN0YXRlID09IFdlYlNvY2tldC5DTE9TSU5HKSB7IC8v5q2j5Zyo5pat5byA5oiW6ICF5bey57uP5pat5byA77yM5YiZ5LiN6IO95Y+R6YCB5raI5oGvXHJcbiAgICAgICAgICAgICAgICByZXR1cm5cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy9jYy5sb2coXCJ3cyBzZW5kd3NtZXNzYWdlOiBcIiwgR2xvYmFsLndzLnJlYWR5U3RhdGUpXHJcbiAgICAgICAgR2xvYmFsLndzLnNlbmQoZGF0YSlcclxuICAgIH1cclxufSkiXX0=